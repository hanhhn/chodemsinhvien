<?xml version="1.0" encoding="UTF-8"?>
<modification>
  <id>Complete SEO Package</id>
  <name>Complete SEO Package</name>
  <code>seo_package</code>
  <version>3.6.8</version>
  <vqmver>2.5.1</vqmver>
  <author>GeekoDev</author>
  <link></link>
  
  <file path="admin/controller/module/complete_seo.php">
    <operation>
      <search position="replace"><![CDATA[$modification_active = false;]]></search>
      <add position="replace"><![CDATA[$modification_active = true;]]></add>
    </operation>
  </file>
  
  <file path="catalog/controller/startup/startup.php" error="skip" v="2.2">
  
    <operation>
      <search position="before" offset="3"><![CDATA[$this->load->model('localisation/language');]]></search>
      <add position="before" offset="3"><![CDATA[    // Seo Package
    $multilingual = new multilingual_seo($this->registry); $multilingual->detect();
    ]]></add>
    </operation>
    
    <operation error="skip">
      <search position="after"><![CDATA[$this->config->set('config_url', HTTP_SERVER);]]></search>
      <add position="after"><![CDATA[      $this->config->set('config_ssl', HTTPS_SERVER);  // SSL fix for OC 2.2]]></add>
    </operation>
    
  </file>
  
  <file path="system/startup.php">
  
    <operation>
      <search position="after"><![CDATA[DIR_SYSTEM . 'engine/registry.php]]></search>
      <add position="after"><![CDATA[
      require_once(DIR_SYSTEM . 'library/multilingual_seo.php');
      require_once(DIR_SYSTEM . 'library/powercache.php');
      ]]></add>
    </operation>
    
  </file>
  
  <!-- Path manager -->
  <file path="catalog/controller/*/seo_url.php" error="skip">
  
		<operation>
			<search position="after"><![CDATA[$categories = explode('_', $value);]]></search>
			<add position="after"><![CDATA[
        if ($this->config->get('mlseo_fpp_directcat')) {
          $categories = array(array_pop($categories));
				}
			]]></add>
		</operation>
    
    <operation>
			<search position="after"><![CDATA[$this->request->get['manufacturer_id'] = $url[1];]]></search>
			<add position="after"><![CDATA[
        if ($this->config->get('mlseo_fpp_brand_parent') && isset($this->request->get['route']) && $this->request->get['route'] == 'product/manufacturer') {
          unset($this->request->get['route']);
				}
			]]></add>
		</operation>

    <operation>
			<search position="before" index="0"><![CDATA[$url .= '/' . $query->row['keyword'];]]></search>
			<add position="before" index="0"><![CDATA[
        if ($data['route'] == 'product/manufacturer/info' && $key == 'manufacturer_id' && $this->config->get('mlseo_fpp_brand_parent')) {
          $this->load->model('tool/path_manager');
          $url .= $this->model_tool_path_manager->getManufacturerKeyword();
        }
			]]></add>
		</operation>
    
		<operation>
			<search position="replace" regex="true"><![CDATA[~parse_str\(\$(url_data|url_info)\['query'\], \$data\);~]]></search>
			<add position="replace"><![CDATA[
        $0
      
				if($data['route'] == 'product/product') {
          if($this->config->get('mlseo_fpp_bypasscat') && isset($data['path'])) {
            unset($data['path']);
          }
          
          if(isset($data['manufacturer_id']) && $this->config->get('mlseo_fpp_mode') != '3') {
            unset($data['manufacturer_id']);
          }
          
          if(!isset($data['path']) && !isset($data['manufacturer_id']) && isset($data['product_id'])) {
            $this->load->model('tool/path_manager');
            $data = (array) $this->model_tool_path_manager->getFullProductPath($data['product_id']) + $data;
          }
				}
        
        $gkd_is_category = ($data['route'] == 'product/category') ? true : false;
			]]></add>
		</operation>
    
  </file>
	
  <file path="catalog/controller/product/category.php">
  
		<operation>
			<search position="after"><![CDATA[public function index() {]]></search>
			<add position="after"><![CDATA[
				// path manager - preserve bc
				if (isset($this->request->get['path']) && $this->config->get('mlseo_fpp_directcat')) {
					$cat_id = strrchr('_'.$this->request->get['path'], '_');
					$cat_id = str_replace('_', '', $cat_id);
          $this->load->model('tool/path_manager');
          $this->request->get['path'] = $this->model_tool_path_manager->getFullCategoryPath($cat_id);
				}
			]]></add>
		</operation>
    
    <operation error="skip" v="2.2" i="canonical">
      <search position="replace"><![CDATA[$this->document->addLink($this->url->link('product/category', 'path=' . $category_info['category_id'], true), 'canonical');]]></search>
      <add position="replace"><![CDATA[$this->load->model('tool/path_manager'); $this->document->addLink($this->url->link('product/category', 'path=' . ($this->config->get('mlseo_fpp_cat_canonical') ? $this->model_tool_path_manager->getFullCategoryPath($category_info['category_id']) : $category_info['category_id']), true), 'canonical');]]></add>
    </operation>
    
	</file><file path="catalog/controller/product/category.php">
  
    <operation error="skip" v="2.x" i="canonical">
      <search position="before"><![CDATA[if ($page == 1) {]]></search>
      <add position="before"><![CDATA[
      if ($page > 1) {
        $this->load->model('tool/path_manager'); $this->document->addLink($this->url->link('product/category', 'path=' . ($this->config->get('mlseo_fpp_cat_canonical') ? $this->model_tool_path_manager->getFullCategoryPath($category_info['category_id']) : $category_info['category_id']) . '&page='. $page, true), 'canonical');
      }
      ]]></add>
    </operation>
    
	</file><file path="catalog/controller/product/category.php">
  
    <operation error="skip" v="2.1" i="canonical">
      <search position="replace"><![CDATA[$this->document->addLink($this->url->link('product/category', 'path=' . $category_info['category_id'], 'SSL'), 'canonical');]]></search>
      <add position="replace"><![CDATA[$this->load->model('tool/path_manager'); $this->document->addLink($this->url->link('product/category', 'path=' . ($this->config->get('mlseo_fpp_cat_canonical') ? $this->model_tool_path_manager->getFullCategoryPath($category_info['category_id']) : $category_info['category_id']), 'SSL'), 'canonical');]]></add>
    </operation>
    
	</file><file path="catalog/controller/product/category.php">
  
    <operation error="skip" v="2.0" i="canonical">
      <search position="replace"><![CDATA[$this->document->addLink($this->url->link('product/category', 'path=' . $this->request->get['path']), 'canonical');]]></search>
      <add position="replace"><![CDATA[$this->load->model('tool/path_manager'); $this->document->addLink($this->url->link('product/category', 'path=' . ($this->config->get('mlseo_fpp_cat_canonical') ? $this->model_tool_path_manager->getFullCategoryPath($category_info['category_id']) : $category_info['category_id']), true), 'canonical');]]></add>
    </operation>
    
	</file>
  
	<!-- breadcrumbs -->
	
	<file path="catalog/controller/product/product.php">
  
		<operation>
			<search position="before" index="0"><![CDATA[if (isset($this->request->get['path'])) {]]></search>
			<add position="before" index="0"><![CDATA[
      // path manager
      if (isset($this->request->get['product_id']) && ((!isset($this->request->get['path']) && $this->config->get('mlseo_fpp_breadcrumbs') == '1') || ($this->config->get('mlseo_fpp_breadcrumbs') == '2')) && is_array($this->request->get)) {
        unset($this->request->get['path']);
        $this->load->model('tool/path_manager');
        $this->request->get = $this->model_tool_path_manager->getFullProductPath($this->request->get['product_id'], true) + $this->request->get;
      }
			]]></add>
		</operation>
    
	</file>

  <file path="catalog/controller/product/search.php">
	
		<operation>
			<search position="replace"><![CDATA[$this->url->link('product/product', 'product_id=' . $result['product_id'] . $url)]]></search>
			<add position="replace"><![CDATA[$this->config->get('mlseo_fpp_remove_search') ? $this->url->link('product/product', 'product_id=' . $result['product_id']) : $this->url->link('product/product', 'product_id=' . $result['product_id'] . $url)]]></add>
		</operation>

	</file>  
  <!-- end path manager-->

  <file path="catalog/controller/common/header.php">
    
    <operation>
      <search position="after"><![CDATA[function index() {]]></search>
      <add position="after"><![CDATA[
      $this->load->model('tool/seo_package');
      $this->model_tool_seo_package->metaRobots();
      $this->model_tool_seo_package->checkCanonical();
      $this->model_tool_seo_package->hrefLang();
      $this->model_tool_seo_package->richSnippets();
      
      if (version_compare(VERSION, '2', '>=')) {
        $data['mlseo_meta'] = $this->document->renderSeoMeta();
      } else {
        $this->data['mlseo_meta'] = $this->document->renderSeoMeta();
      }
      ]]></add>
    </operation>
    
    <operation error="skip" v="1.5">
      <search position="replace"><![CDATA[$this->data['action'] = $this->url->link('common/home');]]></search>
      <add position="replace"><![CDATA[if ($this->config->get('mlseo_enabled')) { $this->data['action'] = ''; }]]></add>
    </operation>

    <operation error="skip" v="1.5">
      <search position="replace" offset="6"><![CDATA[$this->session->data['language'] = $this->request->post['language_code'];]]></search>
      <add position="replace" offset="6"><![CDATA[
        if ($this->config->get('mlseo_enabled')) {
          $this->session->data['language'] = $this->request->post['language_code'];
          if(isset($route) && isset($url)){
            $this->redirect($this->url->link($route, $url));
          }
          else $this->redirect($this->url->link('common/home'));
        }
      ]]></add>
    </operation>
    
  </file>

  <file path="catalog/controller/common/language.php" error="skip" v="2.0">
    
    <operation>
      <search position="replace"><![CDATA[$this->response->redirect($this->request->post['redirect']);]]></search>
      <add position="replace"><![CDATA[
        if (isset($this->request->server['HTTPS']) && (($this->request->server['HTTPS'] == 'on') || ($this->request->server['HTTPS'] == '1'))) {
          $connection = 'SSL';
            } else {
          $connection = 'NONSSL';
        }
      
        $redir_route = $this->request->post['redirect'];
      
      if ($redir_params = strstr($redir_route, '&')) {
          $redir_route = str_replace($redir_params, '', $redir_route);
      } else {
        $redir_params = '';
      }
      
      // handle sub-stores rewriting
      if ($this->config->get('mlseo_store_mode')) {
        $lang_to_store = $this->config->get('mlseo_lang_to_store');
      }
      
      if (!empty($lang_to_store)) {
        $this->response->redirect(str_replace(array(rtrim($this->config->get('config_url'), '/'), rtrim($this->config->get('config_ssl'), '/')), $lang_to_store[$this->request->post['code']], $this->url->link($redir_route, str_replace('&amp;', '&', $redir_params), $connection)));
      }
      
      $this->response->redirect($this->url->link($redir_route, str_replace('&amp;', '&', $redir_params), $connection));
      ]]></add>
    </operation>
    <operation>
      <search position="replace"><![CDATA[if (isset($this->request->post['code'])) {]]></search>
      <add position="replace"><![CDATA[if (isset($this->request->post['code']) && !$this->config->get('mlseo_store_mode')) {
      $lgCodes = array_flip((array) $this->config->get('mlseo_lang_codes'));
      
      if (!empty($lgCodes[$this->request->post['code']])) {
        $this->config->set('config_language', $this->request->post['code']);
        $this->config->set('config_language_id', $lgCodes[$this->request->post['code']]);
      }
      ]]></add>
    </operation>
    <operation>
      <search position="replace"><![CDATA[$data['redirect'] = $this->url->link('common/home');]]></search>
      <add position="replace"><![CDATA[$data['redirect'] = 'common/home';]]></add>
    </operation>
    <operation>
      <search position="replace"><![CDATA[$data['redirect'] = $this->url->link($route, $url, $this->request->server['HTTPS']);]]></search>
      <add position="replace"><![CDATA[$data['redirect'] = $route . $url;]]></add>
    </operation>
    <operation>
      <search position="after"><![CDATA[unset($url_data['route']);]]></search>
      <add position="after"><![CDATA[
      unset($url_data['site_language']);
      unset($url_data['_route_']);
    ]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/controller/module/language.php" error="skip" v="1.5">
    
    <operation>
      <search position="replace"><![CDATA[$this->redirect($this->request->post['redirect']);]]></search>
      <add position="replace"><![CDATA[
        if (isset($this->request->server['HTTPS']) && (($this->request->server['HTTPS'] == 'on') || ($this->request->server['HTTPS'] == '1'))) {
          $connection = 'SSL';
            } else {
          $connection = 'NONSSL';
        }
        
        $redir_route = $this->request->post['redirect'];
        
        if ($redir_params = strstr($redir_route, '&')) {
          $redir_route = str_replace($redir_params, '', $redir_route);
        } else {
          $redir_params = '';
        }
        
        $this->redirect($this->url->link($redir_route, str_replace('&amp;', '&', $redir_params), $connection));
      ]]></add>
    </operation>
    <operation>
      <search position="replace"><![CDATA[$this->data['redirect'] = $this->url->link('common/home');]]></search>
      <add position="replace"><![CDATA[$this->data['redirect'] = 'common/home';]]></add>
    </operation>
    <operation>
      <search position="replace"><![CDATA[$this->data['redirect'] = $this->url->link($route, $url, $connection);]]></search>
      <add position="replace"><![CDATA[$this->data['redirect'] = $route . $url;]]></add>
    </operation>
    <operation>
      <search position="after"><![CDATA[unset($data['_route_']);]]></search>
      <add position="after"><![CDATA[unset($data['site_language']);]]></add>
    </operation>
    
  </file>
  
  <file path="admin/language/english/catalog/*.php">
  
    <operation error="skip">
      <search position="replace"><![CDATA['SEO Keyword:<br /><span class="help">Do not use spaces instead replace spaces with - and make sure the keyword is globally unique.</span>']]></search>
      <add position="replace"><![CDATA['SEO Keyword:']]></add>
    </operation>
    
  </file>
  
  <!--file path="admin/controller/catalog/category.php">

    <operation>
      <search position="replace" offset="4"><![CDATA[foreach ($this->request->post['category_description'] as $language_id => $value) {]]></search>
      <add position="replace" offset="4" trim="true"><![CDATA[
        $default_lang = $this->db->query("SELECT language_id FROM " . DB_PREFIX . "language WHERE code = '" . $this->config->get('config_language') . "'")->row['language_id'];
        foreach ($this->request->post['category_description'] as $language_id => $value) {
          if ($language_id == $default_lang) {
            if ((strlen(utf8_decode($value['name'])) < 2) || (strlen(utf8_decode($value['name'])) > 255)) {
              $this->error['name'][$language_id] = $this->language->get('error_name');
            }
          }
        }
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace" offset="3"><![CDATA[if ((utf8_strlen($value['meta_title']) < 3) || (utf8_strlen($value['meta_title']) > 255)) {]]></search>
      <add position="replace" offset="3" trim="true"><![CDATA[]]></add>
    </operation>
    
  </file>
  
  <file path="admin/controller/catalog/information.php">
    
    <operation>
      <search position="replace" offset="8"><![CDATA[foreach ($this->request->post['information_description'] as $language_id => $value) {]]></search>
      <add position="replace" offset="8" trim="true"><![CDATA[
        $default_lang = $this->db->query("SELECT language_id FROM " . DB_PREFIX . "language WHERE code = '" . $this->config->get('config_language') . "'")->row['language_id'];
        foreach ($this->request->post['information_description'] as $language_id => $value) {
          if ($language_id == $default_lang) {
            if ((utf8_strlen($value['title']) < 3) || (utf8_strlen($value['title']) > 64)) {
              $this->error['title'][$language_id] = $this->language->get('error_title');
            }
          
            if (utf8_strlen($value['description']) < 3) {
              $this->error['description'][$language_id] = $this->language->get('error_description');
            }
          }
        }
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace" offset="3"><![CDATA[if ((utf8_strlen($value['meta_title']) < 3) || (utf8_strlen($value['meta_title']) > 255)) {]]></search>
      <add position="replace" offset="3" trim="true"><![CDATA[]]></add>
    </operation>
    
  </file>
  
  <file path="admin/controller/catalog/product.php">
  
    <operation>
      <search position="replace" offset="4"><![CDATA[foreach ($this->request->post['product_description'] as $language_id => $value) {]]></search>
      <add position="replace" offset="4" trim="true"><![CDATA[
        $default_lang = $this->db->query("SELECT language_id FROM " . DB_PREFIX . "language WHERE code = '" . $this->config->get('config_language') . "'")->row['language_id'];
        foreach ($this->request->post['product_description'] as $language_id => $value) {
          if ($language_id == $default_lang) {
            if ((strlen(utf8_decode($value['name'])) < 1) || (strlen(utf8_decode($value['name'])) > 255)) {
              $this->error['name'][$language_id] = $this->language->get('error_name');
            }
          }
        }
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace" offset="3"><![CDATA[if ((utf8_strlen($value['meta_title']) < 3) || (utf8_strlen($value['meta_title']) > 255)) {]]></search>
      <add position="replace" offset="3" trim="true"><![CDATA[]]></add>
    </operation>
    
  </file-->
  
  <file path="admin/controller/catalog/product.php">
  
    <operation>
      <search position="before"><![CDATA[if (isset($this->request->post['model'])) {]]></search>
      <add position="before"><![CDATA[
    if (isset($this->request->post['meta_robots'])) {
			$data['meta_robots'] = $this->request->post['meta_robots'];
		} elseif (!empty($product_info['meta_robots'])) {
			$data['meta_robots'] = $product_info['meta_robots'];
		} else {
			$data['meta_robots'] = '';
		}
      ]]></add>
    </operation>
    
    <operation error="skip">
      <search position="replace"><![CDATA[if ((utf8_strlen($value['meta_title']) < 3) || (utf8_strlen($value['meta_title']) > 255)) {]]></search>
      <add position="replace"><![CDATA[if (false && (utf8_strlen($value['meta_title']) < 3) || (utf8_strlen($value['meta_title']) > 255)) {]]></add>
    </operation>
    
  </file>
  
  <file path="admin/controller/catalog/category.php">
  
    <operation error="skip">
      <search position="replace"><![CDATA[if ((utf8_strlen($value['meta_title']) < 3) || (utf8_strlen($value['meta_title']) > 255)) {]]></search>
      <add position="replace"><![CDATA[if (false && (utf8_strlen($value['meta_title']) < 3) || (utf8_strlen($value['meta_title']) > 255)) {]]></add>
    </operation>
    
  </file>
  
  <file path="admin/controller/catalog/information.php">
  
    <operation error="skip">
      <search position="replace"><![CDATA[if ((utf8_strlen($value['meta_title']) < 3) || (utf8_strlen($value['meta_title']) > 255)) {]]></search>
      <add position="replace"><![CDATA[if (false && (utf8_strlen($value['meta_title']) < 3) || (utf8_strlen($value['meta_title']) > 255)) {]]></add>
    </operation>
    
  </file>
  
  <file path="admin/model/catalog/category.php">

    <operation>
      <search position="after"><![CDATA[public function addCategory($data) {]]></search>
      <add position="after"><![CDATA[    $default_lang = $this->db->query("SELECT language_id FROM " . DB_PREFIX . "language WHERE code = '" . $this->config->get('config_language') . "'")->row['language_id'];]]></add>
    </operation>
    
    <operation>
      <search position="before" index="0"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "category_description SET]]></search>
      <add position="before" index="0"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        if (isset($data['keyword'])) {
          unset($data['keyword']);
        }
        
        if ($this->config->get('mlseo_insertautotitle')) {
          $value['name'] = ($value['name']) ? $value['name'] : $data['category_description'][$default_lang]['name'];
          $value['description'] = ($value['description']) ? $value['description'] : $data['category_description'][$default_lang]['description'];
        }

        $this->load->model('tool/seo_package');
      
        $seo_kw = '';
        
        if (empty($value['seo_keyword']) && $this->config->get('mlseo_insertautourl')) {
          $seo_kw = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_url_pattern'), $language_id, $data);
        } else if (!empty($value['seo_keyword'])) {
          $seo_kw = html_entity_decode($value['seo_keyword'], ENT_QUOTES, 'UTF-8');
        }
        
        if ($seo_kw) {
          $seo_kw = $this->model_tool_seo_package->filter_seo($seo_kw, 'category', $category_id, $language_id);
        }

        if ($this->config->get('mlseo_ml_mode')) {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'category_id=" . (int)$category_id . "', language_id = '" . (int)$language_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        } else {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'category_id=" . (int)$category_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        }
        
        if (!$value['meta_title'] && $this->config->get('mlseo_insertautoseotitle')) {
          $value['meta_title'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_title_pattern'), $language_id, $data);
        }
        if (!$value['meta_description'] && $this->config->get('mlseo_insertautometadesc')) {
          $value['meta_description'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_description_pattern'), $language_id, $data);
        }
        if (!$value['meta_keyword'] && $this->config->get('mlseo_insertautometakeyword')) {
          $value['meta_keyword'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_keyword_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h1']) && $this->config->get('mlseo_insertautoh1')) {
          $value['seo_h1'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_h1_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h2']) && $this->config->get('mlseo_insertautoh2')) {
          $value['seo_h2'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_h2_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h3']) && $this->config->get('mlseo_insertautoh3')) {
          $value['seo_h3'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_h3_pattern'), $language_id, $data);
        }
      }
      ]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[if ($data['keyword']) {]]></search>
      <add position="replace"><![CDATA[if (!empty($data['keyword']) && !$this->config->get('mlseo_enabled')) {]]></add>
    </operation>
    
    <operation>
      <search position="replace" index="0"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'category_id=" . (int)$category_id]]></search>
      <add position="replace"><![CDATA[    if (!$this->config->get('mlseo_enabled'))
      $this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'category_id=" . (int)$category_id]]></add>
    </operation>
    
    <operation>
      <search position="after" index="0"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "category_description WHERE category_id = '" . (int)$category_id . "'");]]></search>
      <add position="after" index="0"><![CDATA[    if ($this->config->get('mlseo_enabled'))
      $this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'category_id=" . (int)$category_id . "'");]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[public function editCategory($category_id, $data) {]]></search>
      <add position="after"><![CDATA[    $default_lang = $this->db->query("SELECT language_id FROM " . DB_PREFIX . "language WHERE code = '" . $this->config->get('config_language') . "'")->row['language_id'];]]></add>
    </operation>
    
    <operation>
      <search position="before" index="1"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "category_description SET]]></search>
      <add position="before" index="1"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        // cache management
        Powercache::remove('seo_rewrite.' . (int) $language_id, 'path=', (int)$category_id);
        
        if ($this->config->get('mlseo_editautotitle')) {
          $value['name'] = ($value['name']) ? $value['name'] : $data['category_description'][$default_lang]['name'];
          $value['description'] = ($value['description']) ? $value['description'] : $data['category_description'][$default_lang]['description'];
        }
        
        $this->load->model('tool/seo_package');
        
        $seo_kw = '';
        
        if (empty($value['seo_keyword']) && $this->config->get('mlseo_editautourl')) {
          $seo_kw = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_url_pattern'), $language_id, $data);
        } else if (!empty($value['seo_keyword'])) {
          $seo_kw = html_entity_decode($value['seo_keyword'], ENT_QUOTES, 'UTF-8');
        }
        
        if ($seo_kw) {
          $seo_kw = $this->model_tool_seo_package->filter_seo($seo_kw, 'category', $category_id, $language_id);
        }
        
        if ($this->config->get('mlseo_ml_mode')) {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'category_id=" . (int)$category_id . "', language_id = '" . (int)$language_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        } else {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'category_id=" . (int)$category_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        }
        
        if (!$value['meta_title'] && $this->config->get('mlseo_editautoseotitle')) {
          $value['meta_title'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_title_pattern'), $language_id, $data);
        }
        if (!$value['meta_description'] && $this->config->get('mlseo_editautometadesc')) {
          $value['meta_description'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_description_pattern'), $language_id, $data);
        }
        if (!$value['meta_keyword'] && $this->config->get('mlseo_editautometakeyword')) {
          $value['meta_keyword'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_keyword_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h1']) && $this->config->get('mlseo_editautoh1')) {
          $value['seo_h1'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_h1_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h2']) && $this->config->get('mlseo_editautoh2')) {
          $value['seo_h2'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_h2_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h3']) && $this->config->get('mlseo_editautoh3')) {
          $value['seo_h3'] = $this->model_tool_seo_package->transformCategory($this->config->get('mlseo_category_h3_pattern'), $language_id, $data);
        }
      }
      ]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "category_description SET]]></search>
      <add position="replace"><![CDATA[
        $value['seo_h1'] = empty($value['seo_h1']) ? '' : $value['seo_h1'];
        $value['seo_h2'] = empty($value['seo_h2']) ? '' : $value['seo_h2'];
        $value['seo_h3'] = empty($value['seo_h3']) ? '' : $value['seo_h3'];
        
        $extra_fields = '';
        if ($this->config->get('mlseo_enabled')) {
          $extra_fields = "seo_keyword = '" . $this->db->escape($seo_kw) . "', seo_h1 = '" . $this->db->escape($value['seo_h1']) . "', seo_h2 = '" . $this->db->escape($value['seo_h2']) . "', seo_h3 = '" . $this->db->escape($value['seo_h3']) . "', ";
          if (substr(VERSION, 0, 1) == 1) {
            $extra_fields .= "meta_title = '" . $this->db->escape($value['meta_title']) . "', ";
          }
        }
        
        $this->db->query("INSERT INTO " . DB_PREFIX . "category_description SET " . $extra_fields . "]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "category_description]]></search>
      <add position="replace"><![CDATA[
      $extra_select = '';
      
      if ($this->config->get('mlseo_enabled')) {
        if ($this->config->get('mlseo_ml_mode')) {
          $extra_select = ",(SELECT keyword FROM " . DB_PREFIX . "url_alias u WHERE query = 'category_id=".$category_id."'  AND (u.language_id = d.language_id OR u.language_id = 0) LIMIT 1) AS seo_keyword";
        } else {
          $extra_select = ",(SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'category_id=".$category_id."' LIMIT 1) AS seo_keyword";
        }
      }
      
      $query = $this->db->query("SELECT * ".$extra_select." FROM " . DB_PREFIX . "category_description d]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[$result['name'],]]></search>
      <add position="after"><![CDATA[        'seo_keyword'     => isset($result['seo_keyword']) ? $result['seo_keyword'] : '',
        'seo_h1'       => isset($result['seo_h1']) ? $result['seo_h1'] : '',
        'seo_h2'       => isset($result['seo_h2']) ? $result['seo_h2'] : '',
        'seo_h3'       => isset($result['seo_h3']) ? $result['seo_h3'] : '',]]></add>
    </operation>
    
    <operation v="1.5">
      <ignoreif><![CDATA[$this->event->trigger]]></ignoreif>
      <search position="after"><![CDATA[$result['name'],]]></search>
      <add position="after"><![CDATA[        'meta_title'     => isset($result['meta_title']) ? $result['meta_title'] : '',]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[public function deleteCategory($category_id) {]]></search>
      <add position="after"><![CDATA[
      Powercache::remove('seo_rewrite', 'path=', (int)$category_id);
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[, (SELECT DISTINCT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'category_id=" . (int)$category_id . "') AS keyword]]></search>
      <add position="replace"><![CDATA[, (SELECT DISTINCT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'category_id=" . (int)$category_id . "' LIMIT 1) AS keyword]]></add>
    </operation>
    
    <operation error="skip" v="1.5">
      <search position="replace"><![CDATA[, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'category_id=" . (int)$category_id . "') AS keyword]]></search>
      <add position="replace"><![CDATA[, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'category_id=" . (int)$category_id . "' LIMIT 1) AS keyword]]></add>
    </operation>
    
  </file>
  
  <file path="admin/model/catalog/product.php">
  
    <operation>
      <search position="before"><![CDATA[if (isset($data['image'])) {]]></search>
      <add position="before"><![CDATA[
    if (isset($data['meta_robots'])) {
			$this->db->query("UPDATE " . DB_PREFIX . "product SET meta_robots = '" . $this->db->escape($data['meta_robots']) . "' WHERE product_id = '" . (int)$product_id . "'");
		}
      ]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[public function addProduct($data) {]]></search>
      <add position="after"><![CDATA[    $default_lang = $this->db->query("SELECT language_id FROM " . DB_PREFIX . "language WHERE code = '" . $this->config->get('config_language') . "'")->row['language_id'];]]></add>
    </operation>
    
    <operation>
      <search position="before" index="0"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "product_description SET]]></search>
      <add position="before" index="0"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        if (isset($data['keyword'])) {
          unset($data['keyword']);
        }
        
        if ($this->config->get('mlseo_insertautotitle')) {
          $value['name'] = ($value['name']) ? $value['name'] : $data['product_description'][$default_lang]['name'];
          $value['description'] = ($value['description']) ? $value['description'] : $data['product_description'][$default_lang]['description'];
        }
        
        $this->load->model('tool/seo_package');
      
        $data['product_id'] = $product_id; // add product id into dataset for use with patterns
        
        $seo_kw = '';
        
        if (empty($value['seo_keyword']) && $this->config->get('mlseo_insertautourl')) {
          $seo_kw = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_url_pattern'), $language_id, $data);
        } else if (!empty($value['seo_keyword'])) {
          $seo_kw = html_entity_decode($value['seo_keyword'], ENT_QUOTES, 'UTF-8');
        }
        
        if ($seo_kw) {
          $seo_kw = $this->model_tool_seo_package->filter_seo($seo_kw, 'product', $product_id, $language_id);
        }
        
        if ($this->config->get('mlseo_ml_mode')) {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'product_id=" . (int)$product_id . "', language_id = '" . (int)$language_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        } else {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'product_id=" . (int)$product_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        }
        
        if (!$value['meta_title'] && $this->config->get('mlseo_insertautoseotitle')) {
          $value['meta_title'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_title_pattern'), $language_id, $data);
        }
        if (!$value['meta_description'] && $this->config->get('mlseo_insertautometadesc')) {
          $value['meta_description'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_description_pattern'), $language_id, $data);
        }
        if (!$value['meta_keyword'] && $this->config->get('mlseo_insertautometakeyword')) {
          $value['meta_keyword'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_keyword_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h1']) && $this->config->get('mlseo_insertautoh1')) {
          $value['seo_h1'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_h1_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h2']) && $this->config->get('mlseo_insertautoh2')) {
          $value['seo_h2'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_h2_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h3']) && $this->config->get('mlseo_insertautoh3')) {
          $value['seo_h3'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_h3_pattern'), $language_id, $data);
        }
        if (empty($value['image_title']) && $this->config->get('mlseo_insertautoimgtitle')) {
          $value['image_title'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_image_title_pattern'), $language_id, $data);
        }
        if (empty($value['image_alt']) && $this->config->get('mlseo_insertautoimgalt')) {
          $value['image_alt'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_image_alt_pattern'), $language_id, $data);
        }
        if (empty($value['tag']) && $this->config->get('mlseo_insertautotags')) {
          $value['tag'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_tag_pattern'), $language_id, $data);
        }
      }
      ]]></add>
    </operation>
    
    <operation>
      <search position="replace" index="0"><![CDATA[if (isset($data['image'])) {]]></search>
      <add position="replace" index="0"><![CDATA[
        if ($this->config->get('mlseo_insertautoimgname')) {
          $this->load->model('tool/seo_package');
          $seo_image_name = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_image_name_pattern'), $this->config->get('config_language_id'), $data);
          
          $path = pathinfo($data['image']);
          
          $filename = $this->model_tool_seo_package->filter_seo($seo_image_name, 'image', '', '');
          $value = $path['dirname'] . '/' . $filename . '.' . $path['extension'];
          
          if ($data['image'] != $value && file_exists(DIR_IMAGE . $data['image'])) {
            $x = 1;
            
              while (file_exists(DIR_IMAGE . $value)) {
                $value = $path['dirname'] . '/' . $filename . '-' . $x . '.' . $path['extension'];
                $x++;
              }

              if (rename(DIR_IMAGE . $data['image'], DIR_IMAGE . $value)) {
                $this->db->query("UPDATE " . DB_PREFIX . "product SET image = '". $this->db->escape($value) ."' WHERE product_id = '" . (int)$product_id . "'");
              }
            }
        } else if (isset($data['image'])) {
      ]]></add>
    </operation>
    
    <operation>
      <search position="before" index="0"><![CDATA[if (isset($data['product_related'])) {]]></search>
      <add position="before" index="0"><![CDATA[
        if (empty($data['product_related']) && $this->config->get('mlseo_insertautorelated')) {
          $prod_name = str_replace(array('%', '#', "'", '"'), '', $data['product_description'][$default_lang]['name']);
          $prod_tag = str_replace(array('%', '#', "'", '"'), '', $data['product_description'][$default_lang]['tag']);
          $prod_desc = str_replace(array('\n', '\r', '%', '#', "'", '"'), '', $data['product_description'][$default_lang]['description']);
          
          if ($this->config->get('mlseo_product_related_relevance')) {
            $relevance = $this->config->get('mlseo_product_related_relevance');
          } else {
            $relevance = 2;
          }
          
          if ($this->config->get('mlseo_product_related_no')) {
            $max_items = $this->config->get('mlseo_product_related_no');
          } else {
            $max_items = 5;
          }
          
          $rel_query = $this->db->query("SELECT DISTINCT ROUND(MATCH (pd.name, pd.description) AGAINST ('" . $prod_name . " " . $prod_tag . " " . $prod_desc . "'), 0) / 5 as relevance,  p.product_id FROM " . DB_PREFIX . "product_description pd LEFT JOIN " . DB_PREFIX . "product p on pd.product_id = p.product_id INNER JOIN " . DB_PREFIX . "product_to_category pc on pd.product_id = pc.product_id WHERE p.product_id <> " . (int) $product_id . "  AND p.status = 1 GROUP BY p.product_id HAVING relevance >= " . (int) $relevance . " ORDER BY relevance DESC LIMIT 0, " . (int) $max_items)->rows;
          
          foreach ($rel_query as $rel) {
            $data['product_related'][] = $rel['product_id'];
          }
        }
      ]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[if ($data['keyword']) {]]></search>
      <add position="replace"><![CDATA[if (!empty($data['keyword']) && !$this->config->get('mlseo_enabled')) {]]></add>
    </operation>
    
    <operation>
      <search position="replace" index="0"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=" . (int)$product_id]]></search>
      <add position="replace" index="0"><![CDATA[    if (!$this->config->get('mlseo_enabled'))
          $this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=" . (int)$product_id]]></add>
    </operation>
    
    <operation>
      <search position="after" index="0"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product_description WHERE product_id = '" . (int)$product_id . "'");]]></search>
      <add position="after" index="0"><![CDATA[    if ($this->config->get('mlseo_enabled'))
      $this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=" . (int)$product_id . "'");]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[public function editProduct($product_id, $data) {]]></search>
      <add position="after"><![CDATA[    $default_lang = $this->db->query("SELECT language_id FROM " . DB_PREFIX . "language WHERE code = '" . $this->config->get('config_language') . "'")->row['language_id'];]]></add>
    </operation>
    
    <operation>
      <search position="before" index="1"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "product_description SET]]></search>
      <add position="before" index="1"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        // cache management
        Powercache::remove('seo_rewrite.' . (int) $language_id, 'product_id=' . (int)$product_id);
        
        if ($this->config->get('mlseo_editautotitle')) {
          $value['name'] = ($value['name']) ? $value['name'] : $data['product_description'][$default_lang]['name'];
          $value['description'] = ($value['description']) ? $value['description'] : $data['product_description'][$default_lang]['description'];
        }
        
        $this->load->model('tool/seo_package');
        
        $seo_kw = '';
        
        if (empty($value['seo_keyword']) && $this->config->get('mlseo_editautourl')) {
          $seo_kw = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_url_pattern'), $language_id, $data);
        } else if (!empty($value['seo_keyword'])) {
          $seo_kw = html_entity_decode($value['seo_keyword'], ENT_QUOTES, 'UTF-8');
        }
        
        if ($seo_kw) {
          $seo_kw = $this->model_tool_seo_package->filter_seo($seo_kw, 'product', $product_id, $language_id);
        }
        
        if ($this->config->get('mlseo_ml_mode')) {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'product_id=" . (int)$product_id . "', language_id = '" . (int)$language_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        } else {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'product_id=" . (int)$product_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        }
        
        if (!$value['meta_title'] && $this->config->get('mlseo_editautoseotitle')) {
          $value['meta_title'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_title_pattern'), $language_id, $data);
        }
        if (!$value['meta_description'] && $this->config->get('mlseo_editautometadesc')) {
          $value['meta_description'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_description_pattern'), $language_id, $data);
        }
        if (!$value['meta_keyword'] && $this->config->get('mlseo_editautometakeyword')) {
          $value['meta_keyword'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_keyword_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h1']) && $this->config->get('mlseo_editautoh1')) {
          $value['seo_h1'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_h1_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h2']) && $this->config->get('mlseo_editautoh2')) {
          $value['seo_h2'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_h2_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h3']) && $this->config->get('mlseo_editautoh3')) {
          $value['seo_h3'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_h3_pattern'), $language_id, $data);
        }
        if (empty($value['image_title']) && $this->config->get('mlseo_editautoimgtitle')) {
          $value['image_title'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_image_title_pattern'), $language_id, $data);
        }
        if (empty($value['image_alt']) && $this->config->get('mlseo_editautoimgalt')) {
          $value['image_alt'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_image_alt_pattern'), $language_id, $data);
        }
        if (empty($value['tag']) && $this->config->get('mlseo_editautotags')) {
          $value['tag'] = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_tag_pattern'), $language_id, $data);
        }
      }
      ]]></add>
    </operation>
    
    <operation>
      <search position="replace" index="1"><![CDATA[if (isset($data['image'])) {]]></search>
      <add position="replace" index="1"><![CDATA[
        if ($this->config->get('mlseo_editautoimgname')) {
          $this->load->model('tool/seo_package');
          $seo_image_name = $this->model_tool_seo_package->transformProduct($this->config->get('mlseo_product_image_name_pattern'), $this->config->get('config_language_id'), $data);
          
          $path = pathinfo($data['image']);
          
          $filename = $this->model_tool_seo_package->filter_seo($seo_image_name, 'image', '', '');
          $value = $path['dirname'] . '/' . $filename . '.' . $path['extension'];
          
          if ($data['image'] != $value && file_exists(DIR_IMAGE . $data['image'])) {
            $x = 1;
            
              while (file_exists(DIR_IMAGE . $value)) {
                $value = $path['dirname'] . '/' . $filename . '-' . $x . '.' . $path['extension'];
                $x++;
              }

              if (rename(DIR_IMAGE . $data['image'], DIR_IMAGE . $value)) {
                $this->db->query("UPDATE " . DB_PREFIX . "product SET image = '". $this->db->escape($value) ."' WHERE product_id = '" . (int)$product_id . "'");
            }
          }
        } else if (isset($data['image'])) {
      ]]></add>
    </operation>
    
    <operation>
      <search position="before" index="1"><![CDATA[if (isset($data['product_related'])) {]]></search>
      <add position="before" index="1"><![CDATA[
        if (empty($data['product_related']) && $this->config->get('mlseo_editautorelated')) {
          $prod_name = str_replace(array('%', '#', "'", '"'), '', $data['product_description'][$default_lang]['name']);
          $prod_tag = str_replace(array('%', '#', "'", '"'), '', $data['product_description'][$default_lang]['tag']);
          $prod_desc = str_replace(array('\n', '\r', '%', '#', "'", '"'), '', $data['product_description'][$default_lang]['description']);
          
          if ($this->config->get('mlseo_product_related_relevance')) {
            $relevance = $this->config->get('mlseo_product_related_relevance');
          } else {
            $relevance = 2;
          }
          
          if ($this->config->get('mlseo_product_related_no')) {
            $max_items = $this->config->get('mlseo_product_related_no');
          } else {
            $max_items = 5;
          }
          
          $rel_query = $this->db->query("SELECT DISTINCT ROUND(MATCH (pd.name, pd.description) AGAINST ('" . $prod_name . " " . $prod_tag . " " . $prod_desc . "'), 0) / 5 as relevance,  p.product_id FROM " . DB_PREFIX . "product_description pd LEFT JOIN " . DB_PREFIX . "product p on pd.product_id = p.product_id INNER JOIN " . DB_PREFIX . "product_to_category pc on pd.product_id = pc.product_id WHERE p.product_id <> " . (int) $product_id . "  AND p.status = 1 GROUP BY p.product_id HAVING relevance >= " . (int) $relevance . " ORDER BY relevance DESC LIMIT 0, " . (int) $max_items)->rows;
          
          foreach ($rel_query as $rel) {
            $data['product_related'][] = $rel['product_id'];
          }
        }
      ]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "product_description SET]]></search>
      <add position="replace"><![CDATA[
        $value['seo_h1'] = empty($value['seo_h1']) ? '' : $value['seo_h1'];
        $value['seo_h2'] = empty($value['seo_h2']) ? '' : $value['seo_h2'];
        $value['seo_h3'] = empty($value['seo_h3']) ? '' : $value['seo_h3'];
        $value['image_alt'] = empty($value['image_alt']) ? '' : $value['image_alt'];
        $value['image_title'] = empty($value['image_title']) ? '' : $value['image_title'];
      
        $extra_fields = '';
        if ($this->config->get('mlseo_enabled')) {
          $extra_fields = "seo_keyword = '" . $this->db->escape($seo_kw) . "', seo_h1 = '" . $this->db->escape($value['seo_h1']) . "', seo_h2 = '" . $this->db->escape($value['seo_h2']) . "', seo_h3 = '" . $this->db->escape($value['seo_h3']) . "', image_alt = '" . $this->db->escape($value['image_alt']) . "', image_title = '" . $this->db->escape($value['image_title']) . "', ";
          if (substr(VERSION, 0, 1) == 1) {
            $extra_fields .= "meta_title = '" . $this->db->escape($value['meta_title']) . "', ";
          }
        }
        
        $this->db->query("INSERT INTO " . DB_PREFIX . "product_description SET " . $extra_fields . "]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=" . (int)$product_id . "') AS keyword]]></search>
      <add position="replace"><![CDATA[, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=" . (int)$product_id . "' LIMIT 1) AS keyword]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_description]]></search>
      <add position="replace"><![CDATA[
      $extra_select = '';
      
      if ($this->config->get('mlseo_enabled')) {
        if ($this->config->get('mlseo_ml_mode')) {
          $extra_select = ",(SELECT keyword FROM " . DB_PREFIX . "url_alias u WHERE query = 'product_id=".$product_id."'  AND (u.language_id = d.language_id OR u.language_id = 0) LIMIT 1) AS seo_keyword";
        } else {
          $extra_select = ",(SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=".$product_id."' LIMIT 1) AS seo_keyword";
        }
      }
      
      $query = $this->db->query("SELECT * ".$extra_select." FROM " . DB_PREFIX . "product_description d]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[$result['name'],]]></search>
      <add position="after"><![CDATA[        'seo_keyword'     => isset($result['seo_keyword']) ? $result['seo_keyword'] : '',
        'seo_h1'       => isset($result['seo_h1']) ? $result['seo_h1'] : '',
        'seo_h2'       => isset($result['seo_h2']) ? $result['seo_h2'] : '',
        'seo_h3'       => isset($result['seo_h3']) ? $result['seo_h3'] : '',
        'image_alt'       => isset($result['image_alt']) ? $result['image_alt'] : '',
        'image_title'       => isset($result['image_title']) ? $result['image_title'] : '',]]></add>
    </operation>
    
    <operation v="1.5">
      <ignoreif><![CDATA[$this->event->trigger]]></ignoreif>
      <search position="after"><![CDATA[$result['name'],]]></search>
      <add position="after"><![CDATA[        'meta_title'     => isset($result['meta_title']) ? $result['meta_title'] : '',]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[public function deleteProduct($product_id) {]]></search>
      <add position="after"><![CDATA[
      Powercache::remove('seo_rewrite', 'product_id=' . (int)$product_id);
      ]]></add>
    </operation>
    
  </file>
  
  <file path="admin/model/catalog/information.php">
  
    <operation>
      <search position="after"><![CDATA[public function addInformation($data) {]]></search>
      <add position="after"><![CDATA[    $default_lang = $this->db->query("SELECT language_id FROM " . DB_PREFIX . "language WHERE code = '" . $this->config->get('config_language') . "'")->row['language_id'];]]></add>
    </operation>
    
    <operation>
      <search position="before" index="0"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "information_description SET]]></search>
      <add position="before" index="0"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        if (isset($data['keyword'])) {
          unset($data['keyword']);
        }
        
        if ($this->config->get('mlseo_insertautotitle')) {
          $value['title'] = ($value['title']) ? $value['title'] : $data['information_description'][$default_lang]['title'];
          $value['description'] = ($value['description']) ? $value['description'] : $data['information_description'][$default_lang]['description'];
        }
        
        $this->load->model('tool/seo_package');
        
        $seo_kw = '';
        
        if (empty($value['seo_keyword']) && $this->config->get('mlseo_insertautourl')) {
          $seo_kw = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_url_pattern'), $language_id, $data);
        } else if (!empty($value['seo_keyword'])) {
          $seo_kw = html_entity_decode($value['seo_keyword'], ENT_QUOTES, 'UTF-8');
        }
        
        if ($seo_kw) {
          $seo_kw = $this->model_tool_seo_package->filter_seo($seo_kw, 'information', $information_id, $language_id);
        }
      
        if ($this->config->get('mlseo_ml_mode')) {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'information_id=" . (int)$information_id . "', language_id = '" . (int)$language_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        } else {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'information_id=" . (int)$information_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        }
      
        if (!$value['meta_title'] && $this->config->get('mlseo_insertautoseotitle')) {
          $value['meta_title'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_title_pattern'), $language_id, $data);
        }
        if (!$value['meta_description'] && $this->config->get('mlseo_insertautometadesc')) {
          $value['meta_description'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_description_pattern'), $language_id, $data);
        }
        if (!$value['meta_keyword'] && $this->config->get('mlseo_insertautometakeyword')) {
          $value['meta_keyword'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_keyword_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h1']) && $this->config->get('mlseo_insertautoh1')) {
          $value['seo_h1'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_h1_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h2']) && $this->config->get('mlseo_insertautoh2')) {
          $value['seo_h2'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_h2_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h3']) && $this->config->get('mlseo_insertautoh3')) {
          $value['seo_h3'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_h3_pattern'), $language_id, $data);
        }
      }
      ]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[if ($data['keyword']) {]]></search>
      <add position="replace"><![CDATA[if (!empty($data['keyword']) && !$this->config->get('mlseo_enabled')) {]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'information_id=" . (int)$information_id]]></search>
      <add position="replace"><![CDATA[    if (!$this->config->get('mlseo_enabled'))
      $this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'information_id=" . (int)$information_id]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "information_description WHERE information_id = '" . (int)$information_id . "'");]]></search>
      <add position="after"><![CDATA[    if ($this->config->get('mlseo_enabled'))
      $this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'information_id=" . (int)$information_id . "'");]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[public function editInformation($information_id, $data) {]]></search>
      <add position="after"><![CDATA[    $default_lang = $this->db->query("SELECT language_id FROM " . DB_PREFIX . "language WHERE code = '" . $this->config->get('config_language') . "'")->row['language_id'];]]></add>
    </operation>
    
    <operation>
      <search position="before" index="1"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "information_description SET]]></search>
      <add position="before" index="1"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        // cache management
        Powercache::remove('seo_rewrite.' . (int) $language_id, 'information_id=' . (int)$information_id);
        
        if ($this->config->get('mlseo_editautotitle'))
        {
          $value['title'] = ($value['title']) ? $value['title'] : $data['information_description'][$default_lang]['title'];
          $value['description'] = ($value['description']) ? $value['description'] : $data['information_description'][$default_lang]['description'];
        }
        
        $this->load->model('tool/seo_package');
        
        $seo_kw = '';
        
        if (empty($value['seo_keyword']) && $this->config->get('mlseo_editautourl')) {
          $seo_kw = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_url_pattern'), $language_id, $data);
        } else if (!empty($value['seo_keyword'])) {
          $seo_kw = html_entity_decode($value['seo_keyword'], ENT_QUOTES, 'UTF-8');
        }
        
        if ($seo_kw) {
          $seo_kw = $this->model_tool_seo_package->filter_seo($seo_kw, 'information', $information_id, $language_id);
        }
        
        if ($this->config->get('mlseo_ml_mode')) {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'information_id=" . (int)$information_id . "', language_id = '" . (int)$language_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        } else {
          $this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'information_id=" . (int)$information_id . "', keyword = '" . $this->db->escape($seo_kw) . "'");
        }
        
        if (!$value['meta_title'] && $this->config->get('mlseo_insertautoseotitle')) {
          $value['meta_title'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_title_pattern'), $language_id, $data);
        }
        if (!$value['meta_description'] && $this->config->get('mlseo_insertautometadesc')) {
          $value['meta_description'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_description_pattern'), $language_id, $data);
        }
        if (!$value['meta_keyword'] && $this->config->get('mlseo_insertautometakeyword')) {
          $value['meta_keyword'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_keyword_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h1']) && $this->config->get('mlseo_editautoh1')) {
          $value['seo_h1'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_h1_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h2']) && $this->config->get('mlseo_editautoh2')) {
          $value['seo_h2'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_h2_pattern'), $language_id, $data);
        }
        if (empty($value['seo_h3']) && $this->config->get('mlseo_editautoh3')) {
          $value['seo_h3'] = $this->model_tool_seo_package->transformInformation($this->config->get('mlseo_information_h3_pattern'), $language_id, $data);
        }
      }
      ]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "information_description SET]]></search>
      <add position="replace"><![CDATA[
        $value['seo_h1'] = empty($value['seo_h1']) ? '' : $value['seo_h1'];
        $value['seo_h2'] = empty($value['seo_h2']) ? '' : $value['seo_h2'];
        $value['seo_h3'] = empty($value['seo_h3']) ? '' : $value['seo_h3'];
        
        $extra_fields = '';
        if ($this->config->get('mlseo_enabled')) {
          $extra_fields = "seo_keyword = '" . $this->db->escape($seo_kw) . "', seo_h1 = '" . $this->db->escape($value['seo_h1']) . "', seo_h2 = '" . $this->db->escape($value['seo_h2']) . "', seo_h3 = '" . $this->db->escape($value['seo_h3']) . "', ";
          if (substr(VERSION, 0, 1) == 1) {
            $extra_fields .= "meta_title = '" . $this->db->escape($value['meta_title']) . "', meta_keyword = '" . $this->db->escape($value['meta_keyword']) . "', meta_description = '" . $this->db->escape($value['meta_description']) . "', ";
          }
        }
        
        $this->db->query("INSERT INTO " . DB_PREFIX . "information_description SET " . $extra_fields . "]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'information_id=" . (int)$information_id . "') AS keyword]]></search>
      <add position="replace"><![CDATA[, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'information_id=" . (int)$information_id . "' LIMIT 1) AS keyword]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "information_description]]></search>
      <add position="replace"><![CDATA[
      $extra_select = '';
      
      if ($this->config->get('mlseo_enabled')) {
        if ($this->config->get('mlseo_ml_mode')) {
          $extra_select = ",(SELECT keyword FROM " . DB_PREFIX . "url_alias u WHERE query = 'information_id=".$information_id."'  AND (u.language_id = d.language_id OR u.language_id = 0) LIMIT 1) AS seo_keyword";
        } else {
          $extra_select = ",(SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'information_id=".$information_id."' LIMIT 1) AS seo_keyword";
        }
      }
      
      $query = $this->db->query("SELECT * ".$extra_select." FROM " . DB_PREFIX . "information_description d]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[$result['title'],]]></search>
      <add position="after"><![CDATA[        'seo_keyword'     => isset($result['seo_keyword']) ? $result['seo_keyword'] : '',
        'seo_h1'       => isset($result['seo_h1']) ? $result['seo_h1'] : '',
        'seo_h2'       => isset($result['seo_h2']) ? $result['seo_h2'] : '',
        'seo_h3'       => isset($result['seo_h3']) ? $result['seo_h3'] : '',]]></add>
    </operation>
    
    <operation v="1.5">
      <ignoreif><![CDATA[$this->event->trigger]]></ignoreif>
      <search position="after"><![CDATA[$result['title'],]]></search>
      <add position="after"><![CDATA[        'meta_title'     => $result['meta_title'],
        'meta_description'       => $result['meta_description'],
        'meta_keyword'       => $result['meta_keyword'],]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[public function deleteInformation($information_id) {]]></search>
      <add position="after"><![CDATA[
      Powercache::remove('seo_rewrite', 'information_id=' . (int)$information_id);
      ]]></add>
    </operation>
    
  </file>
  
  <file path="admin/model/catalog/manufacturer.php">
  
    <operation>
      <search position="after"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'manufacturer_id=" . (int)$manufacturer_id]]></search>
      <add position="after"><![CDATA[    Powercache::remove('seo_rewrite', 'manufacturer_id=' . (int)$manufacturer_id);]]></add>
    </operation>
    
  </file>
  
  <file path="admin/view/template/catalog/category_form.tpl">
  
    <operation error="skip" v="2.0">
      <search position="replace" offset="8"><![CDATA[<label class="col-sm-2 control-label" for="input-keyword"><span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"><?php echo $entry_keyword; ?></span></label>]]></search>
      <add position="replace" offset="8"><![CDATA[
              <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
              <input type="hidden" name="keyword" />
              <?php } else { ?>
              <label class="col-sm-2 control-label" for="input-keyword"><span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"><?php echo $entry_keyword; ?></span></label>
                <div class="col-sm-10">
                  <input type="text" name="keyword" value="<?php echo $keyword; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-keyword" class="form-control" />
                  <?php if ($error_keyword) { ?>
                  <div class="text-danger"><?php echo $error_keyword; ?></div>
                  <?php } ?>
                </div>
              </div>
              <div class="form-group">
              <?php } ?>
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="before" offset="1"><![CDATA[<?php echo $entry_meta_title; ?></label>]]></search>
      <add position="before" offset="1"><![CDATA[
        <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
        <div class="form-group">
          <label class="col-sm-2 control-label"></label>
          <div class="col-sm-10">
            <btn class="btn btn-block btn-default btnSeoGen" onClick="seoPackageGen('all', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i> Generate all SEO values</btn>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-keyword<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"--><?php echo $entry_keyword; ?><!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="category_description[<?php echo $language['language_id']; ?>][seo_keyword]" value="<?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['seo_keyword'] : ''; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-seo-keyword<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_keyword', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-h1<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"-->SEO H1<!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="category_description[<?php echo $language['language_id']; ?>][seo_h1]" value="<?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['seo_h1'] : ''; ?>" placeholder="SEO H1" id="input-seo-h1<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_h1', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-h2<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"-->SEO H2<!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="category_description[<?php echo $language['language_id']; ?>][seo_h2]" value="<?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['seo_h2'] : ''; ?>" placeholder="SEO H2" id="input-seo-h2<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_h2', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-h3<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"-->SEO H3<!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="category_description[<?php echo $language['language_id']; ?>][seo_h3]" value="<?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['seo_h3'] : ''; ?>" placeholder="SEO H3" id="input-seo-h3<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_h3', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        <script  type="text/javascript"><!--
          $('.btnSeoGen').hover( function(){
            $(this).addClass('btn-primary');
          }, function(){
            $(this).removeClass('btn-primary');
          });
          function seoPackageGen(field, lang) {
            $.ajax({
              url: 'index.php?route=module/complete_seo/get_value&type=category&id=<?php echo isset($_GET['category_id']) ? $_GET['category_id'] : 0; ?>&field='+field+'&lang='+lang+'&token=<?php echo $token; ?>',
              method: 'POST',
              data: $('form#form-category').serialize(),
              dataType: 'json',
              success: function(values) {
                jQuery.each( values, function( i, val ) {
                  if (field == 'description') {
                    if (typeof $('#input-description'+lang).summernote('code') === 'string') {
                    $('[name="'+i+'"]').summernote('code', val);
                  } else {
                      $('[name="'+i+'"]').code(val);
                    }
                  } else {
                    $('[name="'+i+'"]').val(val);
                  }
                  $('[name="'+i+'"]').css('transition', '');
                  $('[name="'+i+'"]').css('background-color', '#FCFFC6');
                  setTimeout(function(){
                    $('[name="'+i+'"]').css('transition', 'all 0.5s ease');
                    $('[name="'+i+'"]').css('background-color', '');
                  }, 10);
                });
              }
            });
          }
        --></script>
        </div>
        <?php } ?>
      ]]></add>
    </operation>
  
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[<input type="text" name="category_description[<?php echo $language['language_id']; ?>][meta_title]" value="<?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['meta_title'] : ''; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title<?php echo $language['language_id']; ?>" class="form-control" />]]></search>
      <add position="replace"><![CDATA[                      <div class="input-group">
                        <input type="text" name="category_description[<?php echo $language['language_id']; ?>][meta_title]" value="<?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['meta_title'] : ''; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title<?php echo $language['language_id']; ?>" class="form-control" />
                        <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('meta_title', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
                      </div>]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[<textarea name="category_description[<?php echo $language['language_id']; ?>][meta_description]" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['meta_description'] : ''; ?></textarea>]]></search>
      <add position="replace"><![CDATA[                      <div class="input-group">
                        <textarea name="category_description[<?php echo $language['language_id']; ?>][meta_description]" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['meta_description'] : ''; ?></textarea>
                        <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('meta_description', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
                      </div>]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[<textarea name="category_description[<?php echo $language['language_id']; ?>][meta_keyword]" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['meta_keyword'] : ''; ?></textarea>]]></search>
      <add position="replace"><![CDATA[                      <div class="input-group">
                        <textarea name="category_description[<?php echo $language['language_id']; ?>][meta_keyword]" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['meta_keyword'] : ''; ?></textarea>
                        <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('meta_keyword', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
                      </div>]]></add>
    </operation>
    
    <operation error="skip" v="1.5">
      <search position="replace" offset="1"><![CDATA[<td><?php echo $entry_keyword; ?></td>]]></search>
      <add position="replace" offset="1"><![CDATA[
            <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
              <td colspan="2"></td>
            <?php } else { ?>
              <td><?php echo $entry_keyword; ?></td>
              <td><input type="text" name="keyword" value="<?php echo $keyword; ?>" /></td>
            <?php } ?>
      ]]></add>
    </operation>
    
    <operation error="skip" v="1.5">
      <search position="before" offset="1"><![CDATA[<td><?php echo $entry_meta_description; ?></td>]]></search>
      <add position="before" offset="1"><![CDATA[
      <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
      <tr>
        <td>SEO Title:</td>
        <td><input type="text" name="category_description[<?php echo $language['language_id']; ?>][meta_title]" size="100" value="<?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['meta_title'] : ''; ?>" /></td>
      </tr>
      <tr>
        <td>SEO H1:</td>
        <td><input type="text" name="category_description[<?php echo $language['language_id']; ?>][seo_h1]" size="100" value="<?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['seo_h1'] : ''; ?>" /></td>
      </tr>
      <?php } ?>
      ]]></add>
      </operation>
    
    <operation error="skip" v="1.5">
      <search position="after" offset="2"><![CDATA[<td><?php echo $entry_description; ?></td>]]></search>
      <add position="after" offset="2"><![CDATA[
        <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
        <tr>
          <td><?php echo $entry_keyword; ?></td>
          <td><input type="text" name="category_description[<?php echo $language['language_id']; ?>][seo_keyword]" size="80" value="<?php echo isset($category_description[$language['language_id']]) ? $category_description[$language['language_id']]['seo_keyword'] : ''; ?>" /></td>
        </tr>
        <?php } ?>
      ]]></add>
    </operation>
    
  </file>
  
  <file path="admin/view/template/catalog/product_form.tpl">
  
    <operation error="skip" v="2.0">
      <search position="before" offset="1"><![CDATA[<?php echo $entry_sort_order; ?></label>]]></search>
      <add position="before" offset="1"><![CDATA[
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-sort-order">Meta Robots</label>
                <div class="col-sm-10">
                  <select class="form-control" name="meta_robots">
                    <option value="" <?php if($meta_robots == '') echo 'selected="selected"'; ?>>all</option>
                    <option value="noindex" <?php if($meta_robots == 'noindex') echo 'selected="selected"'; ?>>noindex, follow</option>
                    <option value="nofollow" <?php if($meta_robots == 'nofollow') echo 'selected="selected"'; ?>>index, nofollow</option>
                    <option value="none" <?php if($meta_robots == 'none') echo 'selected="selected"'; ?>>none</option>
                    <option value="noimageindex" <?php if($meta_robots == 'noimageindex') echo 'selected="selected"'; ?>>noimageindex</option>
                  </select>
                </div>
              </div>
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace" offset="8"><![CDATA[<label class="col-sm-2 control-label" for="input-keyword"><span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"><?php echo $entry_keyword; ?></span></label>]]></search>
      <add position="replace" offset="8"><![CDATA[
              <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
              <input type="hidden" name="keyword" />
              <?php } else { ?>
              <label class="col-sm-2 control-label" for="input-keyword"><span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"><?php echo $entry_keyword; ?></span></label>
                <div class="col-sm-10">
                  <input type="text" name="keyword" value="<?php echo $keyword; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-keyword" class="form-control" />
                  <?php if ($error_keyword) { ?>
                  <div class="text-danger"><?php echo $error_keyword; ?></div>
                  <?php } ?>
                </div>
              </div>
              <div class="form-group">
              <?php } ?>
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="before" offset="1"><![CDATA[<?php echo $entry_meta_title; ?></label>]]></search>
      <add position="before" offset="1"><![CDATA[
        <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
        <div class="form-group">
          <label class="col-sm-2 control-label"></label>
          <div class="col-sm-10">
            <btn class="btn btn-block btn-default btnSeoGen" onClick="seoPackageGen('all', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i> Generate all SEO values</btn>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-keyword<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"--><?php echo $entry_keyword; ?><!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="product_description[<?php echo $language['language_id']; ?>][seo_keyword]" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['seo_keyword'] : ''; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-seo-keyword<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_keyword', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-h1<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"-->SEO H1<!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="product_description[<?php echo $language['language_id']; ?>][seo_h1]" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['seo_h1'] : ''; ?>" placeholder="SEO H1" id="input-seo-h1<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_h1', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-h2<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"-->SEO H2<!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="product_description[<?php echo $language['language_id']; ?>][seo_h2]" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['seo_h2'] : ''; ?>" placeholder="SEO H2" id="input-seo-h2<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_h2', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-h3<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"-->SEO H3<!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="product_description[<?php echo $language['language_id']; ?>][seo_h3]" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['seo_h3'] : ''; ?>" placeholder="SEO H3" id="input-seo-h3<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_h3', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-image-alt<?php echo $language['language_id']; ?>">Image alt</label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="product_description[<?php echo $language['language_id']; ?>][image_alt]" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['image_alt'] : ''; ?>" placeholder="Image alt" id="input-image-alt<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('image_alt', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-image-title<?php echo $language['language_id']; ?>">Image title</label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="product_description[<?php echo $language['language_id']; ?>][image_title]" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['image_title'] : ''; ?>" placeholder="Image title" id="input-image-title<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('image_title', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        <script  type="text/javascript"><!--
          $('.btnSeoGen').hover( function(){
            $(this).addClass('btn-primary');
          }, function(){
            $(this).removeClass('btn-primary');
          });
          
          function seoPackageGen(field, lang) {
            $.ajax({
              url: 'index.php?route=module/complete_seo/get_value&type=product&id=<?php echo isset($_GET['product_id']) ? $_GET['product_id'] : 0; ?>&field='+field+'&lang='+lang+'&token=<?php echo $token; ?>',
              method: 'POST',
              data: $('form#form-product').serialize(),
              dataType: 'json',
              success: function(values) {
                jQuery.each( values, function( i, val ) {
                  if (field == 'description') {
                    if (typeof $('#input-description'+lang).summernote('code') === 'string') {
                    $('[name="'+i+'"]').summernote('code', val);
                  } else {
                      $('[name="'+i+'"]').code(val);
                    }
                  } else {
                    $('[name="'+i+'"]').val(val);
                  }
                  $('[name="'+i+'"]').css('transition', '');
                  $('[name="'+i+'"]').css('background-color', '#FCFFC6');
                  setTimeout(function(){
                    $('[name="'+i+'"]').css('transition', 'all 0.5s ease');
                    $('[name="'+i+'"]').css('background-color', '');
                  }, 10);
                });
              }
            });
          }
        --></script>
        </div>
        <?php } ?>
      ]]></add>
    </operation>
  
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[<input type="text" name="product_description[<?php echo $language['language_id']; ?>][meta_title]" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['meta_title'] : ''; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title<?php echo $language['language_id']; ?>" class="form-control" />]]></search>
      <add position="replace"><![CDATA[                      <div class="input-group">
                        <input type="text" name="product_description[<?php echo $language['language_id']; ?>][meta_title]" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['meta_title'] : ''; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title<?php echo $language['language_id']; ?>" class="form-control" />
                        <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('meta_title', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
                      </div>]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[<textarea name="product_description[<?php echo $language['language_id']; ?>][meta_description]" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['meta_description'] : ''; ?></textarea>]]></search>
      <add position="replace"><![CDATA[                      <div class="input-group">
                        <textarea name="product_description[<?php echo $language['language_id']; ?>][meta_description]" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['meta_description'] : ''; ?></textarea>
                        <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('meta_description', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
                      </div>]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[<textarea name="product_description[<?php echo $language['language_id']; ?>][meta_keyword]" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['meta_keyword'] : ''; ?></textarea>]]></search>
      <add position="replace"><![CDATA[                      <div class="input-group">
                        <textarea name="product_description[<?php echo $language['language_id']; ?>][meta_keyword]" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['meta_keyword'] : ''; ?></textarea>
                        <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('meta_keyword', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
                      </div>]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[<input type="text" name="product_description[<?php echo $language['language_id']; ?>][tag]" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['tag'] : ''; ?>" placeholder="<?php echo $entry_tag; ?>" id="input-tag<?php echo $language['language_id']; ?>" class="form-control" />]]></search>
      <add position="replace"><![CDATA[                      <div class="input-group">
                        <input type="text" name="product_description[<?php echo $language['language_id']; ?>][tag]" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['tag'] : ''; ?>" placeholder="<?php echo $entry_tag; ?>" id="input-tag<?php echo $language['language_id']; ?>" class="form-control" />
                        <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('tag', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
                      </div>]]></add>
    </operation>
    
    <operation error="skip" v="1.5">
      <search position="replace" offset="1"><![CDATA[<td><?php echo $entry_keyword; ?></td>]]></search>
      <add position="replace" offset="1"><![CDATA[
            <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
              <td colspan="2"></td>
            <?php } else { ?>
              <td><?php echo $entry_keyword; ?></td>
              <td><input type="text" name="keyword" value="<?php echo $keyword; ?>" /></td>
            <?php } ?>
      ]]></add>
    </operation>
    
    <operation error="skip" v="1.5">
      <search position="before" offset="1"><![CDATA[<td><?php echo $entry_meta_description; ?></td>]]></search>
      <add position="before" offset="1"><![CDATA[
      <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
      <tr>
        <td>SEO Title:</td>
        <td><input type="text" name="product_description[<?php echo $language['language_id']; ?>][meta_title]" size="100" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['meta_title'] : ''; ?>" /></td>
      </tr>
      <tr>
        <td>SEO H1:</td>
        <td><input type="text" name="product_description[<?php echo $language['language_id']; ?>][seo_h1]" size="100" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['seo_h1'] : ''; ?>" /></td>
      </tr>
      <?php } ?>
      ]]></add>
      </operation>
    
    <operation error="skip" v="1.5">
      <search position="after" offset="2"><![CDATA[<td><?php echo $entry_tag; ?></td>]]></search>
      <add position="after" offset="2"><![CDATA[
      <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
      <tr>
        <td><?php echo $entry_keyword; ?></td>
        <td><input type="text" name="product_description[<?php echo $language['language_id']; ?>][seo_keyword]" size="80" value="<?php echo isset($product_description[$language['language_id']]) ? $product_description[$language['language_id']]['seo_keyword'] : ''; ?>" /></td>
      </tr>
      <?php } ?>
      ]]></add>
    </operation>
    
  </file>
  
  <file path="admin/view/template/catalog/information_form.tpl">
  
    <operation error="skip" v="2.0">
      <search position="replace" offset="8"><![CDATA[<label class="col-sm-2 control-label" for="input-keyword"><span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"><?php echo $entry_keyword; ?></span></label>]]></search>
      <add position="replace" offset="8"><![CDATA[
              <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
              <input type="hidden" name="keyword" />
              <?php } else { ?>
              <label class="col-sm-2 control-label" for="input-keyword"><span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"><?php echo $entry_keyword; ?></span></label>
                <div class="col-sm-10">
                  <input type="text" name="keyword" value="<?php echo $keyword; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-keyword" class="form-control" />
                  <?php if ($error_keyword) { ?>
                  <div class="text-danger"><?php echo $error_keyword; ?></div>
                  <?php } ?>
                </div>
              </div>
              <div class="form-group">
              <?php } ?>
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="before" offset="1"><![CDATA[<?php echo $entry_meta_title; ?></label>]]></search>
      <add position="before" offset="1"><![CDATA[
        <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
        <div class="form-group">
          <label class="col-sm-2 control-label"></label>
          <div class="col-sm-10">
            <btn class="btn btn-block btn-default btnSeoGen" onClick="seoPackageGen('all', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i> Generate all SEO values</btn>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-keyword<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"--><?php echo $entry_keyword; ?><!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="information_description[<?php echo $language['language_id']; ?>][seo_keyword]" value="<?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['seo_keyword'] : ''; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-seo-keyword<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_keyword', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-h1<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"-->SEO H1<!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="information_description[<?php echo $language['language_id']; ?>][seo_h1]" value="<?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['seo_h1'] : ''; ?>" placeholder="SEO H1" id="input-seo-h1<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_h1', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-h2<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"-->SEO H2<!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="information_description[<?php echo $language['language_id']; ?>][seo_h2]" value="<?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['seo_h2'] : ''; ?>" placeholder="SEO H2" id="input-seo-h2<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_h2', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="col-sm-2 control-label" for="input-seo-h3<?php echo $language['language_id']; ?>"><!--span data-toggle="tooltip" title="<?php echo $help_keyword; ?>"-->SEO H3<!--/span--></label>
          <div class="col-sm-10">
            <div class="input-group">
              <input type="text" name="information_description[<?php echo $language['language_id']; ?>][seo_h3]" value="<?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['seo_h3'] : ''; ?>" placeholder="SEO H3" id="input-seo-h3<?php echo $language['language_id']; ?>" class="form-control" />
              <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('seo_h3', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
            </div>
          </div>
        <script  type="text/javascript"><!--
          $('.btnSeoGen').hover( function(){
            $(this).addClass('btn-primary');
          }, function(){
            $(this).removeClass('btn-primary');
          });
          function seoPackageGen(field, lang) {
            $.ajax({
              url: 'index.php?route=module/complete_seo/get_value&type=information&id=<?php echo isset($_GET['information_id']) ? $_GET['information_id'] : 0; ?>&field='+field+'&lang='+lang+'&token=<?php echo $token; ?>',
              method: 'POST',
              data: $('form#form-information').serialize(),
              dataType: 'json',
              success: function(values) {
                jQuery.each( values, function( i, val ) {
                  if (field == 'description') {
                    if (typeof $('#input-description'+lang).summernote('code') === 'string') {
                    $('[name="'+i+'"]').summernote('code', val);
                    } else {
                      $('[name="'+i+'"]').code(val);
                    }
                  } else {
                    $('[name="'+i+'"]').val(val);
                  }
                  $('[name="'+i+'"]').css('transition', '');
                  $('[name="'+i+'"]').css('background-color', '#FCFFC6');
                  setTimeout(function(){
                    $('[name="'+i+'"]').css('transition', 'all 0.5s ease');
                    $('[name="'+i+'"]').css('background-color', '');
                  }, 10);
                });
              }
            });
          }
        --></script>
        </div>
        <?php } ?>
      ]]></add>
    </operation>
  
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[<input type="text" name="information_description[<?php echo $language['language_id']; ?>][meta_title]" value="<?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['meta_title'] : ''; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title<?php echo $language['language_id']; ?>" class="form-control" />]]></search>
      <add position="replace"><![CDATA[                      <div class="input-group">
                        <input type="text" name="information_description[<?php echo $language['language_id']; ?>][meta_title]" value="<?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['meta_title'] : ''; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title<?php echo $language['language_id']; ?>" class="form-control" />
                        <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('meta_title', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
                      </div>]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[<textarea name="information_description[<?php echo $language['language_id']; ?>][meta_description]" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['meta_description'] : ''; ?></textarea>]]></search>
      <add position="replace"><![CDATA[                      <div class="input-group">
                        <textarea name="information_description[<?php echo $language['language_id']; ?>][meta_description]" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['meta_description'] : ''; ?></textarea>
                        <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('meta_description', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
                      </div>]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[<textarea name="information_description[<?php echo $language['language_id']; ?>][meta_keyword]" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['meta_keyword'] : ''; ?></textarea>]]></search>
      <add position="replace"><![CDATA[                      <div class="input-group">
                        <textarea name="information_description[<?php echo $language['language_id']; ?>][meta_keyword]" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword<?php echo $language['language_id']; ?>" class="form-control"><?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['meta_keyword'] : ''; ?></textarea>
                        <span class="input-group-addon btn btn-primary" data-toggle="tooltip" title="Generate value" onClick="seoPackageGen('meta_keyword', '<?php echo $language['language_id']; ?>')"><i class="fa fa-bolt"></i></span>
                      </div>]]></add>
    </operation>
    
    <operation error="skip" v="1.5">
      <search position="replace" offset="2"><![CDATA[<td><?php echo $entry_keyword; ?></td>]]></search>
      <add position="replace" offset="2"><![CDATA[
            <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
              <td colspan="2"></td>
            <?php } else { ?>
              <td><?php echo $entry_keyword; ?></td>
              <td><input type="text" name="keyword" value="<?php echo $keyword; ?>" /></td>
            <?php } ?>
      ]]></add>
    </operation>

    <operation error="skip" v="1.5">
      <search position="before" offset="1"><![CDATA[<td><span class="required">*</span> <?php echo $entry_description; ?></td>]]></search>
      <add position="before" offset="1"><![CDATA[
        <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
        <tr>
          <td>SEO Title:</td>
          <td><input type="text" name="information_description[<?php echo $language['language_id']; ?>][meta_title]" size="100" value="<?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['meta_title'] : ''; ?>" /></td>
        </tr>
            <tr>
          <td>SEO H1:</td>
          <td><input type="text" name="information_description[<?php echo $language['language_id']; ?>][seo_h1]" size="100" value="<?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['seo_h1'] : ''; ?>" /></td>
        </tr>
        <tr>
          <td>Meta Tag Description:</td>
          <td><textarea name="information_description[<?php echo $language['language_id']; ?>][meta_description]" cols="40" rows="5"><?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['meta_description'] : ''; ?></textarea></td>
        </tr>
        <tr>
          <td>Meta Tag Keywords:</td>
          <td><textarea name="information_description[<?php echo $language['language_id']; ?>][meta_keyword]" cols="40" rows="5"><?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['meta_keyword'] : ''; ?></textarea></td>
        </tr>
        <?php } ?>
        ]]></add>
    </operation>
    
    <operation error="skip" v="1.5">
      <search position="after" offset="2"><![CDATA[<span class="error"><?php echo $error_description[$language['language_id']]; ?></span>]]></search>
      <add position="after" offset="2"><![CDATA[
      <?php if (version_compare(VERSION, '2.2', '>=') || $this->registry->get('config')->get('mlseo_enabled')) { ?>
      <tr>
        <td><?php echo $entry_keyword; ?></td>
        <td><input type="text" name="information_description[<?php echo $language['language_id']; ?>][seo_keyword]" size="80" value="<?php echo isset($information_description[$language['language_id']]) ? $information_description[$language['language_id']]['seo_keyword'] : ''; ?>" /></td>
      </tr>
      <?php } ?>
      ]]></add>
    </operation>
    
  </file>
  
  <!-- titles, meta and image alt -->
  <file path="catalog/model/catalog/product.php">
  
    <operation>
      <search position="before"><![CDATA[$query->row['name'],]]></search>
      <add position="before"><![CDATA[
      'meta_title' => isset($query->row['meta_title']) ? $query->row['meta_title'] : '',
      'seo_h1' => isset($query->row['seo_h1']) ? $query->row['seo_h1'] : '',
      'seo_h2' => isset($query->row['seo_h2']) ? $query->row['seo_h2'] : '',
      'seo_h3' => isset($query->row['seo_h3']) ? $query->row['seo_h3'] : '',
      'image_title' => isset($query->row['image_title']) ? $query->row['image_title'] : '',
      'image_alt' => isset($query->row['image_alt']) ? $query->row['image_alt'] : '',
      'meta_robots' => isset($query->row['meta_robots']) ? $query->row['meta_robots'] : '',]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/controller/product/manufacturer.php">
    
    <operation>
      <search position="after"><![CDATA[data['continue'] = $this->url->link('common/home');]]></search>
      <add position="after"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        $this->load->model('tool/seo_package');
        
        if ($this->config->get('mlseo_microdata')) {
          if (version_compare(VERSION, '2', '>=')) {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('microdata', 'manufacturer', $data));
          } else {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('microdata', 'manufacturer', $this->data));
          }
        }
      }
      ]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/controller/information/contact.php">
    
    <operation>
      <search position="before"><![CDATA[data['action'] = $this->url->link('information/contact']]></search>
      <add position="before"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        $this->load->model('tool/seo_package');
        
        if ($this->config->get('mlseo_microdata')) {
          if (version_compare(VERSION, '2', '>=')) {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('microdata', 'contact', $data));
          } else {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('microdata', 'contact', $this->data));
          }
        }
      }
      ]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/controller/product/product.php">

    <operation>
      <search position="replace"><![CDATA[data['heading_title'] = $product_info['name'];]]></search>
      <add position="replace"><![CDATA[data['heading_title'] = !empty($product_info['seo_h1']) && $this->config->get('mlseo_enabled') ? $product_info['seo_h1'] : $product_info['name'];
      
      if (version_compare(VERSION, '2', '>=')) {
        $data['seo_h1'] = !empty($product_info['seo_h1']) ? $product_info['seo_h1'] : '';
        $data['seo_h2'] = !empty($product_info['seo_h2']) ? $product_info['seo_h2'] : '';
        $data['seo_h3'] = !empty($product_info['seo_h3']) ? $product_info['seo_h3'] : '';
      } else {
        $this->data['seo_h1'] = !empty($product_info['seo_h1']) ? $product_info['seo_h1'] : '';
        $this->data['seo_h2'] = !empty($product_info['seo_h2']) ? $product_info['seo_h2'] : '';
        $this->data['seo_h3'] = !empty($product_info['seo_h3']) ? $product_info['seo_h3'] : '';
      }
      
      $this->load->model('catalog/review');
      
      $data['seo_reviews'] = '';
      
      if ($this->config->get('mlseo_reviews')) {
        $gkd_seo_reviews = $this->model_catalog_review->getReviewsByProductId($this->request->get['product_id'], 0, (int)$this->config->get('mlseo_reviews'));
        
        if (count($gkd_seo_reviews)) {
          $data['seo_reviews'] .= '<div class="seo_reviews">';
            foreach ($gkd_seo_reviews as $review) {
              $data['seo_reviews'] .= '<table class="table table-striped table-bordered seo_review">';
              $data['seo_reviews'] .= '<tr>';
              $data['seo_reviews'] .= '  <td style="width: 50%;"><strong>' . $review['author']. '</strong></td>';
              $data['seo_reviews'] .= '  <td class="text-right">' . $review['date_added']. '</td>';
              $data['seo_reviews'] .= '</tr>';
              $data['seo_reviews'] .= '<tr>';
              $data['seo_reviews'] .= '  <td colspan="2"><p>' . $review['text']. '</p>';
              for ($i = 1; $i <= 5; $i++) { 
                if ($review['rating'] < $i) {
                  $data['seo_reviews'] .= '    <span class="fa fa-stack"><i class="fa fa-star-o fa-stack-2x"></i></span>';
                } else {
                  $data['seo_reviews'] .= '    <span class="fa fa-stack"><i class="fa fa-star fa-stack-2x"></i><i class="fa fa-star-o fa-stack-2x"></i></span>';
                }
              }
              $data['seo_reviews'] .= '  </td>';
              $data['seo_reviews'] .= '</tr>';
              $data['seo_reviews'] .= '</table>';
            }
          $data['seo_reviews'] .= '</div>';
        }
      }
      
      if (!empty($product_info['meta_robots'])) {
        $this->document->addSeoMeta('<meta name="robots" content="'.$product_info['meta_robots'].'"/>'."\n");
      }
      
      if ($this->config->get('mlseo_header_lm_product')) {
        $array_lm = array(strtotime($product_info['date_modified']));
        
        if (strtotime($product_info['date_available']) < strtotime(date('Y-m-d'))) {
          $array_lm[] = strtotime($product_info['date_available']);
        }
        
        $special_query = $this->db->query("SELECT date_start, date_end FROM " . DB_PREFIX . "product_special ps WHERE ps.product_id = '".(int)$product_id."' AND ps.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW()))")->row;
        
        if (!empty($special_query['date_start']) && strtotime($special_query['date_start']) < strtotime(date('Y-m-d'))) {
          $array_lm[] = strtotime($special_query['date_start']);
        }
        
        if (!empty($special_query['date_end']) && strtotime($special_query['date_end']) < strtotime(date('Y-m-d'))) {
          $array_lm[] = strtotime($special_query['date_end']);
        }
        
        $review_query = $this->db->query("SELECT date_modified FROM " . DB_PREFIX . "review WHERE product_id = '" . (int)$product_id . "' AND status = '1' ORDER BY date_modified DESC LIMIT 1")->row;
        
        if (!empty($review_query['date_modified']) && strtotime($review_query['date_modified']) < strtotime(date('Y-m-d'))) {
          $array_lm[] = strtotime($review_query['date_modified']);
        }
        
        $gkd_header_lm_date = max($array_lm);
        
        $this->response->addHeader('Last-Modified: '.date('D, d M Y H:i:s', $gkd_header_lm_date).' GMT');
      }
      ]]></add>
    </operation>
      
    <operation>
      <search position="after"><![CDATA[$this->model_catalog_product->updateViewed]]></search>
      <add position="after"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        $this->load->model('tool/seo_package');
        
        if ($this->config->get('mlseo_opengraph')) {
          if (version_compare(VERSION, '2', '>=')) {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('opengraph', 'product', $data + array('product_info' => $product_info)));
          } else {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('opengraph', 'product', $this->data + array('product_info' => $product_info)));
          }
        }

        if ($this->config->get('mlseo_tcard')) {
          if (version_compare(VERSION, '2', '>=')) {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('tcard', 'product', $data + array('product_info' => $product_info)));
          } else {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('tcard', 'product', $this->data + array('product_info' => $product_info)));
          }
        }

        if ($this->config->get('mlseo_microdata')) {
          if (version_compare(VERSION, '2', '>=')) {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('microdata', 'product', $data + array('product_info' => $product_info)));
          } else {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('microdata', 'product', $this->data + array('product_info' => $product_info)));
          }
        }
      }
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[$this->document->setTitle($product_info['meta_title']);]]></search>
      <add position="replace"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        $this->document->setTitle(!empty($product_info['meta_title']) ? $product_info['meta_title'] : $product_info['name']);
        $data['image_alt'] = !empty($product_info['image_alt']) ? $product_info['image_alt'] : '';
        $data['image_title'] = !empty($product_info['image_title']) ? $product_info['image_title'] : '';
      } else {
        $this->document->setTitle($product_info['meta_title']);
      }
      ]]></add>
    </operation>
  
    <operation error="skip" v="1.5">
      <search position="replace"><![CDATA[$this->document->setTitle($product_info['name']);]]></search>
      <add position="replace"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        $this->document->setTitle(!empty($product_info['meta_title']) ? $product_info['meta_title'] : $product_info['name']);
        $this->data['image_alt'] = !empty($product_info['image_alt']) ? $product_info['image_alt'] : '';
        $this->data['image_title'] = !empty($product_info['image_title']) ? $product_info['image_title'] : '';
      } else {
        $this->document->setTitle($product_info['name']);
      }
      ]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/view/theme/*/template/product/product.tpl">
  
    <!--operation error="skip"> Now in json
      <search position="before"><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="before"><![CDATA[<?php echo !empty($mlseo_microdata) ? $mlseo_microdata : ''; ?>]]></add>
    </operation-->
    
    <!--operation error="skip"> seo reviews, now set it manually
      <search position="replace" error="skip"><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="replace"><![CDATA[
<?php if ($gkd_seo_reviews) { ?>
<div style="display:none">
<?php foreach ($gkd_seo_reviews as $review) { ?>
<p><?php echo $review['author']; ?> - <?php echo $review['date_added']; ?><br/><?php echo $review['text']; ?></p>
<?php } ?>
</div>
<?php } ?>
<?php echo $footer; ?>]]></add>
    </operation-->
    
    <operation error="skip">
      <search position="replace"><![CDATA[alt="<?php echo $heading_title; ?>"]]></search>
      <add position="replace"><![CDATA[alt="<?php echo !empty($image_alt) ? $image_alt : $heading_title; ?>"]]></add>
    </operation>
    
    <operation error="skip">
      <search position="replace"><![CDATA[title="<?php echo $heading_title; ?>"]]></search>
      <add position="replace"><![CDATA[title="<?php echo !empty($image_title) ? $image_title : $heading_title; ?>"]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/view/theme/*/template/product/category.tpl">
  
    <operation error="skip">
      <search position="replace"><![CDATA[title="<?php echo $product['name']; ?>"]]></search>
      <add position="replace"><![CDATA[title="<?php echo !empty($product['image_title']) ? $product['image_title'] : $product['name']; ?>"]]></add>
    </operation>
    
    <operation error="skip">
      <search position="replace"><![CDATA[alt="<?php echo $product['name']; ?>"]]></search>
      <add position="replace"><![CDATA[alt="<?php echo !empty($product['image_alt']) ? $product['image_alt'] : $product['name']; ?>"]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/controller/product/category.php">

    <operation>
      <search position="replace"><![CDATA[data['heading_title'] = $category_info['name'];]]></search>
      <add position="replace"><![CDATA[data['heading_title'] = !empty($category_info['seo_h1']) && $this->config->get('mlseo_enabled') ? $category_info['seo_h1'] : $category_info['name'];
      if (version_compare(VERSION, '2', '>=')) {
        $data['seo_h1'] = !empty($category_info['seo_h1']) ? $category_info['seo_h1'] : '';
        $data['seo_h2'] = !empty($category_info['seo_h2']) ? $category_info['seo_h2'] : '';
        $data['seo_h3'] = !empty($category_info['seo_h3']) ? $category_info['seo_h3'] : '';
      } else {
        $this->data['seo_h1'] = !empty($category_info['seo_h1']) ? $category_info['seo_h1'] : '';
        $this->data['seo_h2'] = !empty($category_info['seo_h2']) ? $category_info['seo_h2'] : '';
        $this->data['seo_h3'] = !empty($category_info['seo_h3']) ? $category_info['seo_h3'] : '';
      }
      
      if ($this->config->get('mlseo_enabled')) {
        $this->load->model('tool/seo_package');
        
        if ($this->config->get('mlseo_microdata')) {
          if (version_compare(VERSION, '2', '>=')) {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('microdata', 'category', $data));
          } else {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('microdata', 'category', $this->data));
          }
        }
      }
      
      if ($this->config->get('mlseo_header_lm_category')) {
        $gkd_header_lm_date = strtotime($category_info['date_modified']);
        
        $this->response->addHeader('Last-Modified: '.date('D, d M Y H:i:s', $gkd_header_lm_date).' GMT');
      }
      ]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[=> $result['product_id'],]]></search>
        <add position="after"><![CDATA[
        'image_title' => isset($result['image_title']) ? $result['image_title'] : '',
        'image_alt' => isset($result['image_alt']) ? $result['image_alt'] : '',
        ]]></add>
    </operation>
    
    <operation error="skip" v="2.0"><!-- fix canonical and prev next links-->
      <search position="replace"><![CDATA[$this->url->link('product/category', 'path=' . $category_info['category_id']]]></search>
      <add position="replace"><![CDATA[$this->url->link('product/category', 'path=' . ($this->config->get('mlseo_enabled') && $this->config->get('mlseo_pagination_fix') ? $this->request->get['path'] : $category_info['category_id'])]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[$this->document->setTitle($category_info['meta_title']);]]></search>
      <add position="replace"><![CDATA[$this->document->setTitle(!empty($category_info['meta_title']) && $this->config->get('mlseo_enabled') ? $category_info['meta_title'] : $category_info['name']);]]></add>
    </operation>
  
    <operation error="skip" v="1.5">
      <search position="replace"><![CDATA[$this->document->setTitle($category_info['name']);]]></search>
      <add position="replace"><![CDATA[$this->document->setTitle(!empty($category_info['meta_title']) && $this->config->get('mlseo_enabled') ? $category_info['meta_title'] : $category_info['name']);]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/controller/information/information.php">
    
    <operation>
      <search position="replace"><![CDATA[data['heading_title'] = $information_info['title'];]]></search>
      <add position="replace"><![CDATA[data['heading_title'] = !empty($information_info['seo_h1']) && $this->config->get('mlseo_enabled') ? $information_info['seo_h1'] : $information_info['title'];
        
        if (version_compare(VERSION, '2', '>=')) {
          $data['seo_h1'] = !empty($information_info['seo_h1']) ? $information_info['seo_h1'] : '';
          $data['seo_h2'] = !empty($information_info['seo_h2']) ? $information_info['seo_h2'] : '';
          $data['seo_h3'] = !empty($information_info['seo_h3']) ? $information_info['seo_h3'] : '';
        } else {
          $this->data['seo_h1'] = !empty($information_info['seo_h1']) ? $information_info['seo_h1'] : '';
          $this->data['seo_h2'] = !empty($information_info['seo_h2']) ? $information_info['seo_h2'] : '';
          $this->data['seo_h3'] = !empty($information_info['seo_h3']) ? $information_info['seo_h3'] : '';
        }
        
        $this->load->model('tool/seo_package');
  
        if ($this->config->get('mlseo_opengraph')) {
          if (version_compare(VERSION, '2', '>=')) {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('opengraph', 'info', $data));
          } else {
            $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('opengraph', 'info', $this->data));
          }
          
          if ($this->config->get('mlseo_microdata')) {
            if (version_compare(VERSION, '2', '>=')) {
              $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('microdata', 'information', $data));
            } else {
              $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('microdata', 'information', $this->data));
            }
          }
        }
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="replace"><![CDATA[$this->document->setTitle($information_info['meta_title']);]]></search>
      <add position="replace"><![CDATA[$this->document->setTitle(!empty($information_info['meta_title']) && $this->config->get('mlseo_enabled') ? $information_info['meta_title'] : $information_info['title']);]]></add>
    </operation>
    
    <operation error="skip" v="1.5">
      <search position="replace"><![CDATA[$this->document->setTitle($information_info['title']);]]></search>
      <add position="replace"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        $this->document->setTitle(($information_info['meta_title'] ? $information_info['meta_title'] : $information_info['title']));
        $this->document->setKeywords($information_info['meta_keyword']);
        $this->document->setDescription($information_info['meta_description']);
      } else {
        $this->document->setTitle($information_info['title']);
      }
      ]]></add>
    </operation>  
    
  </file>
  
    <file path="catalog/controller/*/seo_url.php" error="skip">
  
    <operation>
      <search position="after" offset="1"><![CDATA[$this->url->addRewrite($this);]]></search>
      <add position="after" offset="1"><![CDATA[
      if ($this->config->get('mlseo_enabled')) {
        // redirection manager
        $url = urldecode('http' . (!empty($_SERVER['HTTPS']) ? 's' : '') . '://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI']);
        $uri = urldecode($_SERVER['REQUEST_URI']);
        
        if ($this->config->get('mlseo_redirect_dynamic') && isset($this->request->get['route']) && !(!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest')) {
          $redir_request = $this->request->get;
          $redir_route = $redir_request['route'];
          unset($redir_request['route']);
          
          if (!empty($_SERVER['HTTPS'])) {
            $redir_url = $this->url->link($redir_route, http_build_query($redir_request, '', '&'), $_SERVER['HTTPS']);
          } else {
            $redir_url = $this->url->link($redir_route, http_build_query($redir_request, '', '&'));
          }
          
          
          if (rtrim($redir_url, '/') != rtrim($url, '/') && !strpos($redir_url, 'route=')) {
            header('HTTP/1.1 301 Moved Permanently');
            header('Location: ' . $redir_url); 
            exit;
          }
        }
        
        $redirect = $this->db->query("SELECT redirect, language_id FROM " . DB_PREFIX . "url_redirect WHERE query = '" . $this->db->escape($url) . "' OR query = '" . $this->db->escape($uri) . "' LIMIT 1")->row;
        
        if(!empty($redirect['redirect'])) {
          $lang = $redirect['language_id'];
          $redirect = $redirect['redirect'];
          
          if ((substr($redirect, 0, 1) != '/') && (substr($redirect, 0, 4) != 'http')) {
            $this->load->model('localisation/language');
            $languagesArray = $this->model_localisation_language->getLanguages();
            
            if(count($languagesArray) > 1) {
              $languages = array();
              foreach ($languagesArray as $result) { $languages[$result['language_id']] = $result; }
              $this->config->set('config_language_id', $languages[$lang]['language_id']);
              $this->config->set('config_language', $languages[$lang]['code']);
              $this->session->data['language'] = $languages[$lang]['code'];
            }
          
            if ($params = strstr($redirect, '&')) {
              $route = str_replace(array($params, 'index.php?route='), '', $redirect);
            } else {
              $params = '';
            }
            
            $redirect = str_replace('&amp;', '&', $this->url->link($route, substr(str_replace('&amp;', '&', $params), 1)));
          }
          
          if ($redirect != $url) {
            header('HTTP/1.1 301 Moved Permanently');
            header('Location: ' . $redirect); 
            exit;
          }
        }
      }
      ]]></add>
    </operation>
    
    <operation i="canonical redir">
      <search position="after" offset="2"><![CDATA[$this->request->get['route'] = 'information/information';]]></search>
      <add position="after" offset="2"><![CDATA[
        if (isset($this->request->get['route']) && $this->config->get('mlseo_redirect_canonical')) {
          $url = urldecode('http' . (!empty($_SERVER['HTTPS']) ? 's' : '') . '://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI']);
          $uri = urldecode($_SERVER['REQUEST_URI']);
          
          $redir_request = $this->request->get;
          $redir_route = $redir_request['route'];
          unset($redir_request['route'], $redir_request['_route_']);
          
          if (!empty($_SERVER['HTTPS'])) {
            if ($this->request->get['route'] == 'product/category' && $this->config->get('mlseo_redirect_canonical_cat')) {
              $this->load->model('tool/path_manager');
              
              $cat_id = strstr($redir_request['path'], '_') ? substr(strrchr($redir_request['path'], '_'), 1) : $redir_request['path'];
              
              $redir_url = str_replace('&amp;', '&', $this->url->link('product/category', 'path=' . ($this->config->get('mlseo_fpp_cat_canonical') ? $this->model_tool_path_manager->getFullCategoryPath($cat_id) : $cat_id), $_SERVER['HTTPS']));
            } else {
              $redir_url = str_replace('&amp;', '&', $this->url->link($redir_route, http_build_query($redir_request, '', '&'), $_SERVER['HTTPS']));
            }
          } else {
            if ($this->request->get['route'] == 'product/category' && $this->config->get('mlseo_redirect_canonical_cat')) {
              $this->load->model('tool/path_manager');
              
              $cat_id = strstr($redir_request['path'], '_') ? substr(strrchr($redir_request['path'], '_'), 1) : $redir_request['path'];
              
              $redir_url = str_replace('&amp;', '&', $this->url->link('product/category', 'path=' . ($this->config->get('mlseo_fpp_cat_canonical') ? $this->model_tool_path_manager->getFullCategoryPath($cat_id) : $cat_id)));
            } else {
              $redir_url = str_replace('&amp;', '&', $this->url->link($redir_route, http_build_query($redir_request, '', '&')));
            }
          }
          
          if (!strpos($redir_url, 'route=') && (($redir_url != str_replace('&amp;', '&', $url)) && (urldecode($redir_url) != str_replace('&amp;', '&', $url)))) {
            header('HTTP/1.1 301 Moved Permanently');
            header('Location: ' . $redir_url); 
            exit;
          }
        }
      ]]></add>
    </operation>
    
    <operation i="cache">
      <search position="after"><![CDATA[if (isset($data['route'])) {]]></search>
      <add position="after"><![CDATA[
      $url_cache = NULL;
      if ($this->config->get('mlseo_cache') && $this->config->get('mlseo_enabled'))
        $url_cache = Powercache::get('seo_rewrite.' . $this->config->get('config_language_id'), $this->db->escape($key . '=' . $value));
      if ($url_cache === NULL) {
        $old_url = $url;
      ]]></add>
    </operation>

    <operation>
      <search position="replace"><![CDATA[if (isset($this->request->get['_route_'])) {]]></search>
      <add position="replace"><![CDATA[  /*if ($this->config->get('mlseo_flag') && !isset($this->request->get["_route_"]) && !isset($this->request->get["route"])) {
        if ($this->config->get('mlseo_default_lang') == substr($this->session->data['language'], 0, 2) || $this->config->get('mlseo_default_lang') == $this->session->data['language']) {
          if (version_compare(VERSION, '2', '>=')) return new Action('common/home');
          else return $this->forward('common/home');
        } else {
          if (version_compare(VERSION, '2', '>=')) $this->response->redirect($this->url->link('common/home'));
          else $this->redirect($this->url->link('common/home'));
        }
      }
      */
      if (!empty($this->request->get['_route_'])) {
        if ($this->config->get('mlseo_extension')) {
          $this->request->get['_route_'] = str_replace($this->config->get('mlseo_extension'), '', $this->request->get['_route_']);
        }]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[foreach ($parts as $part) {]]></search>
      <add position="replace"><![CDATA[
      $seoIsCategory = false;
      
			foreach ($parts as $part) {
      
        if ($this->config->get('mlseo_enabled') && $this->config->get('mlseo_pagination') && (!empty($this->request->get['path']) || !empty($this->request->get['search'])) && preg_match('/page-(\d+)/', $part, $page)) {
          $this->request->get['page'] = $page[1];
          continue;
        }
      ]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[public function rewrite($link) {]]></search>
      <add position="after"><![CDATA[
        if (isset($this->session->data['language']) && !($this->session->data['language'] == $this->config->get('config_language') || $this->session->data['language'] == strstr($this->config->get('config_language'), '-', true))) {
          $this->load->model('localisation/language');
          $languagesById = $this->model_localisation_language->getLanguages();
          $languages = array();
          foreach ($languagesById as $result) {
            $languages[$result['code']] = $result;
            if (strpos($result['code'], '-')) {
              $languages[strstr($result['code'], '-', true)] = $result;
            }
          }
          $this->config->set('config_language_id', $languages[ $this->session->data['language'] ]['language_id']);
        }
        
        $lang = isset($this->session->data['language']) ? $this->session->data['language'] : $this->config->get('config_language');
        
        if ($this->config->get('mlseo_ml_mode')) {
          $ml_mode = "AND (`language_id` = '" . (int)$this->config->get('config_language_id') . "' OR `language_id` = 0) ORDER BY language_id DESC";
        } else {
          $ml_mode = '';
        }
      ]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[$categories = explode('_', $value);]]></search>
      <add position="after"><![CDATA[
          $last_cat = count($categories)-1;
          foreach ($categories as $cat_key => $cat_id) {
            if($cat_key != $last_cat && in_array($cat_id, (array) $this->config->get('mlseo_fpp_categories'))) {
              unset($categories[$cat_key]);
            }
          }
      ]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE keyword = '" . $this->db->escape($part) . "'");]]></search>
      <add position="replace"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE keyword = '" . $this->db->escape($part) . "' OR keyword = '" . $this->db->escape($this->request->get['_route_']) . "'");
      
        if ($this->config->get('mlseo_enabled') && $this->config->get('mlseo_absolute') && $query->num_rows > 1) {
          foreach ($query->rows as $key => $row) {
            if (!$seoIsCategory && strpos($row['query'], 'category_id=') !== 0) {
              $query->row = $row;
              $query->rows = array($row);
              break;
            }
          }
        }
      ]]></add>
    </operation>
    
    <operation>
      <search position="before"><![CDATA[if ($url[0] == 'product_id') {]]></search>
      <add position="before"><![CDATA[
          if ($url[0] == 'route') {
            $this->request->get['route'] = $url[1];
          }
          
          if (isset($url[1]) && !in_array($url[0], array('route', 'product_id', 'category_id', 'information_id', 'manufacturer_id', 'blog_article_id'))) {
            $this->request->get[$url[0]] = $url[1];
          }
      ]]></add>
    </operation>
    
    <operation>
      <search position="after"><![CDATA[if ($url[0] == 'category_id') {]]></search>
      <add position="after"><![CDATA[
            $seoIsCategory = true;
            
            if ($this->config->get('mlseo_enabled') && $this->config->get('mlseo_absolute') && $query->num_rows > 1) {
              $parent_id = 0;
              
              if (!empty($this->request->get['path'])) {
            $parent_id = str_replace('_', '', strrchr($this->request->get['path'], '_'));
                
                if(!$parent_id) {
                  $parent_id = $this->request->get['path'];
                }
              }
            
              $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias u left join " . DB_PREFIX . "category c on c.category_id = REPLACE(u.query, 'category_id=', '') WHERE u.keyword = '" . $this->db->escape($part) . "' AND c.parent_id = '" . $this->db->escape($parent_id) . "'");
                    if (isset($query->row['query']))
              $url = explode('=', $query->row['query']);
            }
      ]]></add>
    </operation>
    
    <operation>
      <search position="before" index="0"><![CDATA[$url .= '/' . $query->row['keyword'];]]></search>
      <add position="before" index="0"><![CDATA[if ($this->config->get('mlseo_enabled') && !(($data['route'] == 'product/manufacturer/info' || $data['route'] == 'product/product') && $key == 'manufacturer_id')) $url .= '/' . $query->row['keyword'] . $this->config->get('mlseo_extension'); else]]></add>
    </operation>

    <operation>
      <search position="replace"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = '" . $this->db->escape($key . '=' . (int)$value) . "'");]]></search>
      <add position="replace"><![CDATA[
            $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = '" . $this->db->escape($key . '=' . (int)$value) . "'" . $ml_mode);
      ]]></add>
    </operation>
    
    <operation>
      <search position="replace"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = 'category_id=" . (int)$category . "'");]]></search>
      <add position="replace"><![CDATA[
              $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = 'category_id=" . (int)$category . "'" . $ml_mode);
      ]]></add>
    </operation>
    
    <operation error="skip" v="2.0">
      <search position="before"><![CDATA[$query .= '&' . rawurlencode((string)$key) . '=' . rawurlencode((string)$value);]]></search>
      <add position="before"><![CDATA[        if ($key != 'site_language')]]></add>
    </operation>
    
    <operation error="skip" v="2.0.1+ fix">
      <search position="replace"><![CDATA[if ($query->row['query'] &&]]></search>
      <add position="replace"><![CDATA[if (empty($this->request->get['route']) && $url[0] != 'route' && !empty($query->row['query']) &&]]></add>
    </operation>
    
    <operation error="skip" v="1.5.5 - 2.x">
      <search position="before"><![CDATA[return $url_info['scheme']]]></search>
      <add position="before"><![CDATA[
        
        if ($this->config->get('mlseo_enabled') && $this->config->get('mlseo_flag') && !($this->config->get('mlseo_flag_default') && ($this->config->get('mlseo_default_lang') == $lang))) {
          if ($this->config->get('mlseo_flag_short')) {
            $lang = substr($lang, 0, 2);
          }
          
          $url = ($this->config->get('mlseo_flag_upper')) ? '/'.strtoupper($lang).$url : '/'.$lang.$url;
        }
        
        $url = rtrim($url, '/');
        
        if ($this->config->get('mlseo_cat_slash') && !empty($gkd_is_category)) {
          $url .= '/';
        }
      ]]></add>
    </operation>
    
    <operation error="skip">
      <search position="replace"><![CDATA[elseif ($key == 'path') {]]></search>
      <add position="replace"><![CDATA[
          elseif ($this->config->get('mlseo_enabled') && $key == 'route' && $value == 'common/home') {
            $url .= '/';
          } elseif ($this->config->get('mlseo_enabled') && $this->config->get('mlseo_pagination') && $key == 'page' && $url && isset($data['route']) && ($data['route'] == 'product/category' || $data['route'] == 'product/search')) {
            $url .= '/page-'.$value;
            unset($data[$key]);
          } elseif ($key == 'path') {
      ]]></add>
    </operation>
    
    <operation error="skip" v="1.5">
      <search position="before"><![CDATA[$query .= '&' . $key . '=' . $value;]]></search>
      <add position="before"><![CDATA[        if ($key != 'site_language')]]></add>
    </operation>
    
    <operation error="skip" v="1.5.4">
      <search position="before"><![CDATA[return $url_data['scheme']]]></search>
      <add position="before"><![CDATA[
        if ($this->config->get('mlseo_enabled') && $this->config->get('mlseo_flag') && !($this->config->get('mlseo_flag_default') && ($this->config->get('mlseo_default_lang') == $lang))) {
          $url = ($this->config->get('mlseo_flag_upper')) ? '/'.strtoupper($lang).$url : '/'.$lang.$url;
        }
        
        $url = rtrim($url, '/');
        
        if ($this->config->get('mlseo_cat_slash') && !empty($gkd_is_category)) {
          $url .= '/';
        }
      ]]></add>
    </operation>
    
  </file><file path="catalog/controller/*/seo_url.php" error="skip">
  
    <operation error="skip" v="journal theme">
      <ignoreif><![CDATA[if ($is_journal2_blog && $this->model_journal2_blog->getBlogKeyword()) {]]></ignoreif>
      <search position="before" offset="3"><![CDATA[if ($url) {]]></search>
      <add position="before" offset="3"><![CDATA[
          elseif ($this->config->get('mlseo_enabled') && $this->config->get('mlseo_friendly') && $value != 'common/home'  && !in_array($key, array('path', 'product_id', 'category_id', 'manufacturer_id', 'information_id'))) {
            $query = $this->db->query("SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE `query` = '" . $this->db->escape($key . '=' . $value) . "'" . $ml_mode);
            if ($query->num_rows) {
              $url .= '/' . $query->row['keyword'];
              $url .= $query->row['keyword'] ? $this->config->get('mlseo_extension') : '';
              if($key != 'route') unset($data[$key]);
            }
          }
          
        if ($this->config->get('mlseo_cache'))
          Powercache::add('seo_rewrite.' . $this->config->get('config_language_id'), $this->db->escape($key . '=' . $value), str_replace($old_url, '', $url));
      } else if ($url_cache) {
        $url .= $url_cache;
        unset($data[$key]);
      } //end cache
      ]]></add>
    </operation>
    
    <operation error="skip" v="journal theme">
      <search position="before" offset="4"><![CDATA[if ($is_journal2_blog && $this->model_journal2_blog->getBlogKeyword()) {]]></search>
      <add position="before" offset="4"><![CDATA[
          elseif ($this->config->get('mlseo_enabled') && $this->config->get('mlseo_friendly') && $value != 'common/home'  && !in_array($key, array('path', 'product_id', 'category_id', 'manufacturer_id', 'information_id'))) {
            $query = $this->db->query("SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE `query` = '" . $this->db->escape($key . '=' . $value) . "'" . $ml_mode);
            if ($query->num_rows) {
              $url .= '/' . $query->row['keyword'];
              $url .= $query->row['keyword'] ? $this->config->get('mlseo_extension') : '';
              unset($data[$key]);
            }
          }
          
        if ($this->config->get('mlseo_cache'))
          Powercache::add('seo_rewrite.' . $this->config->get('config_language_id'), $this->db->escape($key . '=' . $value), str_replace($old_url, '', $url));
      } else if ($url_cache) {
        $url .= $url_cache;
        unset($data[$key]);
      } //end cache
      ]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/model/design/banner.php">
  
    <operation i="ml banners">
      <search position="before"><![CDATA[return $query->rows;]]></search>
      <add position="before"><![CDATA[
        if ($this->config->get('mlseo_banners')) {
          foreach($query->rows as &$row) {
            if ($row['link'] && strstr($row['link'], 'http') === false) {
              $route = $row['link'];
              
              if ($params = strstr($row['link'], '&')) {
                $route = str_replace(array($params, 'index.php?route='), '', $row['link']);
              } else {
                $params = '';
              }
              
              $row['link'] = $this->url->link($route, str_replace('&amp;', '&', $params));
            }
          }
        }
       ]]></add>
    </operation>
    
  </file>
  
  <file path="admin/controller/common/menu.php" error="skip">
  
    <operation>
      <search position="after"><![CDATA[$this->load->language('common/menu');]]></search>
      <add position="after"><![CDATA[
      $this->load->model('extension/extension');
      if (in_array('complete_seo', $this->model_extension_extension->getInstalled('module'))) {
        $data['text_complete_seo'] = 'Complete SEO';
        $data['link_complete_seo'] = $this->url->link('module/complete_seo', 'token=' . $this->session->data['token'], 'SSL');
      } else {
        $data['text_complete_seo'] = 'Install Complete SEO';
        $data['link_complete_seo'] = $this->url->link('extension/module/install', 'extension=complete_seo&token=' . $this->session->data['token'], 'SSL');
      }
      ]]></add>
    </operation>
    
  </file>
  
  <file path="admin/controller/common/column_left.php" error="skip" v="2.3">
  
    <operation error="skip">
      <search position="before"><![CDATA[if ($this->user->hasPermission('access', 'extension/event')) {]]></search>
      <add position="before"><![CDATA[
      $this->load->model('extension/extension');
      
      if (!in_array('complete_seo', $this->model_extension_extension->getInstalled('module'))) {
        $extension[] = array(
					'name'	   => '<img style="vertical-align:top" src="view/seo_package/img/icon.png"/> Install Complete SEO',
					'href'     => $this->url->link('extension/extension/module/install', 'extension=complete_seo&redir=1&token=' . $this->session->data['token'], true),
					'children' => array()		
				);
      } else if ($this->user->hasPermission('access', 'module/complete_seo')) {
				$extension[] = array(
					'name'	   => '<img style="vertical-align:top" src="view/seo_package/img/icon.png"/> Complete SEO',
					'href'     => $this->url->link('module/complete_seo', 'token=' . $this->session->data['token'], true),
					'children' => array()		
				);
			}
      ]]></add>
    </operation>
    
  </file>
  
  <file path="admin/view/template/common/menu.tpl" error="skip" v="2.1 - 2.2">
  
    <operation>
      <search position="after"><![CDATA[<li><a href="<?php echo $feed; ?>"><?php echo $text_feed; ?></a></li>]]></search>
      <add position="after"><![CDATA[
      <li><a href="<?php echo $link_complete_seo; ?>"><img style="vertical-align:top" src="view/seo_package/img/icon.png"/> <?php echo $text_complete_seo; ?></a></li>
      ]]></add>
    </operation>
    
  </file>
  
  <file path="admin/view/template/common/header.tpl" error="skip" v="1.5">
  
    <operation error="skip">
      <search position="after"><![CDATA[<li><a href="<?php echo $feed; ?>">]]></search>
      <add position="after"><![CDATA[
      <?php $this->load->model('setting/extension'); if (in_array('complete_seo', $this->model_setting_extension->getInstalled('module'))){ ?>
      <li><a href="<?php echo $this->url->link('module/complete_seo', 'token=' . $this->session->data['token'], 'SSL'); ?>"><img style="vertical-align:top" src="view/seo_package/img/icon.png"/> Complete SEO</a></li>
      <?php }else{ ?>
      <li><a href="<?php echo $this->url->link('extension/module/install', 'extension=complete_seo&token=' . $this->session->data['token'], 'SSL'); ?>"><img style="vertical-align:top" src="../seo_package/img/icon.png"/> Install Complete SEO</a></li>
      <?php } ?>
      ]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/controller/common/home.php">
  
    <operation>
      <search position="after" offset="1"><![CDATA[$this->document->setDescription]]></search>
      <add position="after" offset="1"><![CDATA[
  // seo meta (overwrites the previously defined)
  if ($this->config->get('mlseo_enabled')) {
    $seo_meta = $this->config->get('mlseo_store');
    if (isset($seo_meta[$this->config->get('config_store_id').$this->config->get('config_language_id')])) {
      $seo_meta = $seo_meta[$this->config->get('config_store_id').$this->config->get('config_language_id')];
    }
    
    if (!empty($seo_meta['seo_title'])) {
      ${'this'}->document->setTitle($seo_meta['seo_title']);
    } else if ($this->config->get('config_meta_title')) {
      ${'this'}->document->setTitle($this->config->get('config_meta_title'));
    } else {
      ${'this'}->document->setTitle($this->config->get('config_title'));
    }
    
    if (!empty($seo_meta['description'])) {
      ${'this'}->document->setDescription($seo_meta['description']);
    } else {
      ${'this'}->document->setDescription($this->config->get('config_meta_description'));
    }
    
    if (!empty($seo_meta['keywords'])) {
      ${'this'}->document->setKeywords($seo_meta['keywords']);
    }
    
    if (version_compare(VERSION, '2', '>=')) {
      if (!empty($seo_meta['title'])) {
        $data['heading_title'] = $data['seo_h1'] = $seo_meta['title'];
      } else if ($this->config->get('config_meta_title')) {
        $data['heading_title'] = $data['seo_h1'] = $this->config->get('config_meta_title');
      } else {
        $data['heading_title'] = $data['seo_h1'] = $this->config->get('config_title');
      }
      $data['heading_title'] = $data['seo_h1'] = !empty($seo_meta['title']) ? $seo_meta['title'] : $this->config->get('config_title');
      $data['seo_h2'] = !empty($seo_meta['h2']) ? $seo_meta['h2'] : '';
      $data['seo_h3'] = !empty($seo_meta['h3']) ? $seo_meta['h3'] : '';
    } else {
      $this->data['heading_title'] = $this->data['seo_h1'] = !empty($seo_meta['title']) ? $seo_meta['title'] : $this->config->get('config_title');
      $this->data['seo_h2'] = !empty($seo_meta['h2']) ? $seo_meta['h2'] : '';
      $this->data['seo_h3'] = !empty($seo_meta['h3']) ? $seo_meta['h3'] : '';
    }
  }
  /* now defined in header ctrl
  $this->load->model('tool/seo_package');
  
  if ($this->config->get('mlseo_opengraph')) {
    if (version_compare(VERSION, '2', '>=')) {
      $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('opengraph', 'home'));
    } else {
      $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('opengraph', 'home'));
    }
  }
  
  if ($this->config->get('mlseo_tcard')) {
    if (version_compare(VERSION, '2', '>=')) {
      $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('tcard', 'home'));
    } else {
      $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('tcard', 'home'));
    }
  }
  
  if ($this->config->get('mlseo_gpublisher')) {
    if (version_compare(VERSION, '2', '>=')) {
      $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('gpublisher', 'home'));
    } else {
      $this->document->addSeoMeta($this->model_tool_seo_package->rich_snippet('gpublisher', 'home'));
    }
  }
  */
  // end - seo meta
      ]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/view/theme/*/template/common/header.tpl">
  
    <operation i="hreflang">
      <search position="before"><![CDATA[<?php foreach ($links as $link) { ?>]]></search>
      <add position="before"><![CDATA[
<?php if (!empty($mlseo_meta)) { echo $mlseo_meta; } ?>
      ]]></add>
    </operation>
    
    <operation error="skip" i="opengraph">
      <search position="replace"><![CDATA[<head>]]></search>
      <add position="replace"><![CDATA[<head prefix="og:http://ogp.me/ns# fb:http://ogp.me/ns/fb# product:http://ogp.me/ns/product#">]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/controller/error/not_found.php">
  
    <operation>
      <search position="after"><![CDATA[public function index() {]]></search>
      <add position="after"><![CDATA[
    $this->load->model('tool/seo_package');
    $this->model_tool_seo_package->addUrl404(urldecode('http' . (!empty($_SERVER['HTTPS']) ? 's' : '') . '://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI']));
      ]]></add>
    </operation>
    
  </file>
  
  <file path="system/library/pagination.php">
  
    <operation error="skip" v="2.2" i="smart pagination">
      <search position="replace"><![CDATA[str_replace('&amp;page={page}']]></search>
      <add position="replace"><![CDATA[str_replace(array('&amp;page={page}','/page-{page}')]]></add>
    </operation>
    
  </file><file path="system/library/pagination.php">
  
    <operation error="skip" v="2.3" i="smart pagination">
      <search position="replace"><![CDATA[array('&amp;page={page}', '&page={page}')]]></search>
      <add position="replace"><![CDATA[array('?page={page}', '&amp;page={page}', '&page={page}', '/page-{page}')]]></add>
    </operation>
    
  </file>
  
  <file path="system/engine/controller.php">
  
    <operation error="skip" v="1.5" i="canonical urls">
      <search position="after"><![CDATA[protected function render() {]]></search>
      <add position="after"><![CDATA[
    /*if (!in_array(strstr($this->template, '/'), array('/template/account/login.tpl', '/template/common/column_left.tpl', '/template/common/column_right.tpl', '/template/common/content_top.tpl', '/template/common/content_bottom.tpl',
                                      '/template/common/footer.tpl', '/template/common/header.tpl', '/template/module/language.tpl', '/template/module/currency.tpl', '/template/module/cart.tpl'))) {*/
      if (in_array(strstr($this->template, '/'), array('/template/product/category.tpl', '/template/product/product.tpl', '/template/information/information.tpl', '/template/information/contact.tpl', '/template/information/sitemap.tpl'))) {
      $doc = $this->registry->get('document');
      if ($doc) {
        if (!isset($this->request->get['route'])) {
           $route = 'common/home';
        } else {
          $data = $this->request->get;
          unset($data['_route_']);
          $route = $data['route'];
          foreach($data as $param => $value) {
            if (!in_array($param, array('path', 'product_id', 'category_id', 'manufacturer_id', 'information_id','page')))
            unset($data[$param]);
          }
          $url = '';
          if ($data) {
            $route .= '&' . urldecode(http_build_query($data, '', '&'));
          }  
        }
        $doc->addLink($this->url->link($route), 'canonical');
      }
    }
      ]]></add>
    </operation>
    
  </file>
  
  <file path="catalog/controller/journal2/menu.php" error="skip" i="journal">
  
    <operation error="skip">
      <search position="replace"><![CDATA[$href = Journal2Utils::getProperty($item, 'menu.menu_item.url');]]></search>
      <add position="replace"><![CDATA[
        // SEO package link
        if (strpos(Journal2Utils::getProperty($item, 'menu.menu_item.url'), 'index.php?route=') !== false) {
          $href = $this->url->link(str_replace('index.php?route=', '', Journal2Utils::getProperty($item, 'menu.menu_item.url')));
        } else {
          $href = Journal2Utils::getProperty($item, 'menu.menu_item.url');
        }
      ]]></add>
    </operation>
    
  </file>
  
  <file path="system/library/document.php">
  
    <operation>
      <search position="before"><![CDATA[public function setTitle($title) {]]></search>
      <add position="before"><![CDATA[
        private $seo_meta = '';

        public function addSeoMeta($html) {
          $this->seo_meta .= $html;
        }
        
        public function renderSeoMeta() {
          return $this->seo_meta;
        }
      ]]></add>
    </operation>
    
  </file>
  
  <file path="admin/controller/extension/extension/module.php" i="fix 2.3 link" error="skip">
  
    <operation error="skip">
			<search position="before"><![CDATA[$data['extensions'][] = array(]]></search>
			<add position="before"><![CDATA[
        if ($extension == 'complete_seo') {
          $data['extensions'][] = array(
            'name'      => $this->language->get('heading_title'),
            'module'    => $module_data,
            'install'   => $this->url->link('extension/extension/module/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, true),
            'uninstall' => $this->url->link('extension/extension/module/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, true),
            'installed' => in_array($extension, $extensions),
            'edit'      => $this->url->link('module/' . $extension, 'token=' . $this->session->data['token'], true)
          );
          continue;
        }
			]]></add>
		</operation>
		
	</file>
  
  <file path="admin/controller/extension/extension/feed.php" i="fix 2.3 link" error="skip">
  
    <operation error="skip">
			<search position="before"><![CDATA[$data['extensions'][] = array(]]></search>
			<add position="before"><![CDATA[
        if ($extension == 'seopackage_sitemap') {
          $data['extensions'][] = array(
            'name'      => $this->language->get('heading_title'),
            'status'    => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
            'install'   => $this->url->link('extension/extension/feed/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, true),
            'uninstall' => $this->url->link('extension/extension/feed/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, true),
            'installed' => in_array($extension, $extensions),
            'edit'      => $this->url->link('feed/' . $extension, 'token=' . $this->session->data['token'], true)
          );
          continue;
        }
			]]></add>
		</operation>
		
	</file>
  
</modification>